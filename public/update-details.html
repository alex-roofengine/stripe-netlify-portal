<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Details</title>
  <!-- Google Font Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script>window.STRIPE_PUBLISHABLE_KEY='pk_test_51RaOwTH2B4qCgYPku1eH6qxmhVQTHprYixDOIs5ZQeH0aUxPnDbdjtdgG1mPr5l9aiqHZYoDaCl8ftViQaYucekw00rA3kMvP3';</script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body,html{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif;}
    .sidebar{background:#000;color:#fff;width:280px;position:fixed;height:100%;padding:2em;box-sizing:border-box;}
    .content{margin-left:280px;padding:2em;}
    h1,h2{margin-top:0;font-weight:600;}
    .btn-yellow,.btn-red{padding:1em 2em;border:none;border-radius:6px;font-weight:600;cursor:pointer;margin-right:20px;}
    .btn-yellow{background:#ffc107;color:#000;}
    .btn-red{background:#dc3545;color:#fff;}
    #pms, #history{margin-top:1em;max-width:600px;}
    .pm, .invoice{margin:.5em 0;}
    @media(max-width:768px){.sidebar{position:relative;width:100%;height:auto;padding:1em;} .content{margin-left:0;padding:1em;} .btn-yellow,.btn-red{width:100%;margin-bottom:.5em;}}
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" width="150" alt="RoofEngine" />
    <h2>Welcome to the<br/>RoofEngine Billing Portal</h2>
    <p id="timestamp"></p>
    <p id="context"></p>
  </div>
  <div class="content">
    <h1>Billing</h1>
    <div id="plan"></div>
    <button class="btn-yellow" id="pause">⏸ Pause retainer</button>
    <button class="btn-red" id="cancel">⚠ Cancel retainer</button>
    <h2>Payment method</h2>
    <div id="pms"></div>
    <button id="add-pm" class="btn-green">+ Add payment method</button>
    <p id="pm-message" style="color:#28a745;"></p>
    <h2>Billing history</h2>
    <div id="history"></div>
  </div>
  <script>
    const stripe = Stripe(window.STRIPE_PUBLISHABLE_KEY);
    const params=new URLSearchParams(location.search);
    const customerId=params.get('customerId');
    let customerName='';

    function updateTime(){const opts={timeZone:'America/New_York',month:'long',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true};document.getElementById('timestamp').textContent='Today is '+new Intl.DateTimeFormat('en-US',opts).format(new Date())+' EST';}
    updateTime();setInterval(updateTime,60000);

    // Fetch customer name for context
    (async()=>{
      const custs=await fetch('/.netlify/functions/list-customers').then(r=>r.json());
      const c=custs.find(x=>x.id===customerId);
      customerName=c?c.name:customerId;
      document.getElementById('context').textContent='You are updating the details for: '+customerName;
    })();

    // Subscriptions
    (async()=>{
      const subs=await fetch(`/.netlify/functions/list-subscriptions?customerId=${customerId}`).then(r=>r.json());
      const planEl=document.getElementById('plan');
      subs.forEach(s=>{
        const status=s.status.charAt(0).toUpperCase()+s.status.slice(1);
        planEl.innerHTML+=`<div><strong>${s.plan.nickname}</strong> (${status})</div><div>${(s.plan.amount/100).toFixed(2)} USD · renews on ${new Date(s.current_period_end*1000).toLocaleDateString()}</div>`;
        document.getElementById('pause').onclick=()=>confirm('Pause this retainer?')&&fetch('/.netlify/functions/pause-subscription',{method:'POST',body:JSON.stringify({subscriptionId:s.id})}).then(()=>location.reload());
        document.getElementById('cancel').onclick=()=>confirm('Cancel this retainer?')&&fetch('/.netlify/functions/cancel-subscription',{method:'POST',body:JSON.stringify({subscriptionId:s.id})}).then(()=>location.reload());
      });
    })();

    // Payment Methods
    (async()=>{
      const pms=await fetch(`/.netlify/functions/list-payment-methods?customerId=${customerId}`).then(r=>r.json());
      const cont=document.getElementById('pms');
      pms.forEach(pm=>{
        const div=document.createElement('div');div.className='pm';
        div.innerHTML=`${pm.card.brand.toUpperCase()} •••• ${pm.card.last4} (exp ${pm.card.exp_month}/${pm.card.exp_year})${pm.id===pm.customer.invoice_settings?.default_payment_method?' <em>Default</em>':''} <button onclick="stripe.detachPaymentMethod('${pm.id}').then(()=>location.reload())">✖</button>`;
        cont.append(div);
      });
    })();

    // Add Payment Method
    document.getElementById('add-pm').onclick=async()=>{
      const {clientSecret}=await fetch('/.netlify/functions/create-setup-intent',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customerId})}).then(r=>r.json());
      const holder=document.createElement('div');holder.innerHTML='<div id="new-card"></div><button id="save-pm" class="btn-green" style="margin-top:.5em;">Save Card</button>';
      document.getElementById('pms').append(holder);
      const elements=stripe.elements();const card2=elements.create('card',{style:{base:{fontFamily:'Inter, sans-serif'}}});card2.mount('#new-card');
      document.getElementById('save-pm').onclick=async()=>{
        const {setupIntent,error}=await stripe.confirmCardSetup(clientSecret,{payment_method:{card:card2}});
        if(error)return alert(error.message);
        await fetch('/.netlify/functions/attach-method',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customerId,paymentMethodId:setupIntent.payment_method})});
        document.getElementById('pm-message').textContent='✅ Payment method updated!';
      };
    };

    // Billing History
    (async()=>{
      const invs=await fetch(`/.netlify/functions/list-invoices?customerId=${customerId}`).then(r=>r.json());
      const hist=document.getElementById('history');
      invs.forEach(i=>{
        const date=new Date(i.created*1000).toLocaleDateString();
        const status=i.status.charAt(0).toUpperCase()+i.status.slice(1);
        hist.innerHTML+=`<div class="invoice"><a href="${i.hosted_invoice_url}" target="_blank">${date}</a> · ${(i.amount_paid/100).toFixed(2)} USD · ${status}${status==='Failed'?` (Reason: ${i.failure_message})`:''}</div>`;
      });
    })();
  </script>
</body>
</html>
