<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outbound Management</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body,html{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif}

    .sidebar{
      position:fixed;left:0;top:0;width:280px;height:100%;
      background:#000;color:#fff;padding:2em;display:flex;flex-direction:column
    }
    .sidebar img{width:150px;margin-bottom:1em}
    .sidebar h2{font-size:1.25em;margin:0 0 1em}
    .sidebar p{margin:.25em 0 1em}
    .sidebar a{color:#fff;text-decoration:none}
    .sidebar .small{font-size:.9em;color:#cfcfcf}
    .sidebar .back{
      display:inline-block;margin-top:auto;padding:.5em .75em;border:1px solid #555;border-radius:6px
    }

    .content{margin-left:280px;padding:2em}
    h1{font-weight:700;margin:0 0 1em}
    .card{border:1px solid #e5e5e5;border-radius:10px;padding:1em 1.25em;margin-bottom:1.25em;background:#fff}
    .card h3{margin:.25em 0 .75em;font-size:1.05em}

    .row{display:flex;justify-content:space-between;align-items:center}
    .muted{color:#666}

    /* PM list */
    .pm{display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e5e5;border-radius:8px;padding:.75em 1em;margin:.5em 0}
    .default-badge{background:#007bff;color:#fff;border-radius:4px;padding:2px 6px;font-size:.8em;margin-left:.5em}

    /* Table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:.75em;border-bottom:1px solid #eee;text-align:left;font-size:.95em}
    th{font-weight:600}
    .status-badge{
      display:inline-block;padding:.2em .5em;border-radius:999px;font-weight:600;font-size:.8em
    }
    .status-succeeded{background:#e8f7ee;color:#1a7f37}
    .status-failed{background:#fde8ea;color:#b42318}
    .nowrap{white-space:nowrap}

    .selector{display:flex;gap:.75em;align-items:center;margin-bottom:1em}
    .selector select{padding:.5em .75em;border:1px solid #ccc;border-radius:6px}

    @media(max-width:768px){
      .sidebar{position:relative;width:100%;height:auto}
      .content{margin-left:0}
      .row{flex-direction:column;align-items:flex-start;gap:.25em}
      .pm{flex-direction:column;align-items:flex-start;gap:.25em}
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" alt="RoofEngine" />
    <h2>Welcome to the<br/>RoofEngine Billing Portal</h2>
    <p id="timestamp" class="small"></p>

    <a class="back" href="outbound-management.html">⟵ Back to selector</a>
    <a class="back" style="margin-top:.75em" href="index.html">⟵ Home</a>
  </div>

  <div class="content">
    <h1 id="pageTitle">Outbound Management</h1>

    <!-- Customer selector -->
    <div class="card">
      <div class="selector">
        <label for="customerSel"><strong>Select client:</strong></label>
        <select id="customerSel">
          <option value="" disabled selected>Loading customers…</option>
        </select>
        <span class="muted" id="selectorHelp">
          If you don't see a client in this list, please contact tech support.
        </span>
      </div>
    </div>

    <!-- Company -->
    <div class="card" id="companyCard">
      <h3>Company</h3>
      <div class="row">
        <div>
          <div id="companyName" style="font-weight:600">—</div>
          <div class="muted" id="personLine">—</div>
          <div class="muted" id="companyEmail">—</div>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="card">
      <h3>Payment Methods</h3>
      <div id="pmList"></div>
    </div>

    <!-- Billing history (Payments) -->
    <div class="card">
      <h3>Billing History</h3>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Statement Descriptor</th>
            <th>Description</th>
            <th>Payment Method</th>
            <th>Receipt</th>
          </tr>
        </thead>
        <tbody id="paymentsBody">
          <tr><td colspan="7" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Clock (EST)
    function updateTime(){
      const opts={ timeZone:'America/New_York', month:'long', day:'numeric',
                   hour:'numeric', minute:'2-digit', hour12:true };
      document.getElementById('timestamp').textContent =
        'Today is ' + new Intl.DateTimeFormat('en-US',opts).format(new Date()) + ' EST';
    }
    updateTime(); setInterval(updateTime, 60000);

    // Helpers
    const fmtMoney = (cents, curr='usd') =>
      new Intl.NumberFormat('en-US', { style:'currency', currency: curr.toUpperCase() })
        .format((cents||0)/100);

    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const fmtDate = (unix) => {
      const d = new Date(unix*1000);
      const mo = monthNames[d.getMonth()];
      const day = d.getDate();
      const yr = d.getFullYear();
      const time = d.toLocaleTimeString('en-US',{hour:'numeric', minute:'2-digit'});
      return `${mo} ${day}, ${yr} ${time}`;
    };

    function capWord(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }

    // Load all customers (then filter to outbound in the UI)
    async function loadCustomers(){
      const list = await fetch('/.netlify/functions/list-customers').then(r=>r.json());
      const sel = document.getElementById('customerSel');
      sel.innerHTML = '<option value="" disabled selected>Select a client…</option>';

      const outboundOnly = list.filter(c => (c.metadata && c.metadata.client_type === 'outbound'));
      outboundOnly.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name || c.email || c.id;
        sel.appendChild(opt);
      });

      // If we were deep-linked with ?customerId=...
      const urlId = new URLSearchParams(location.search).get('customerId');
      if (urlId) {
        const exists = outboundOnly.find(x=>x.id===urlId);
        if (exists) {
          sel.value = urlId;
          onCustomerChange(urlId, exists);
        }
      }

      sel.onchange = async () => {
        const id = sel.value;
        const found = outboundOnly.find(x=>x.id===id);
        onCustomerChange(id, found);
        // update URL
        const u = new URL(location.href);
        u.searchParams.set('customerId', id);
        history.replaceState(null,'',u.toString());
      };
    }

    async function onCustomerChange(customerId, customer){
      // Header
      document.getElementById('pageTitle').textContent =
        `Outbound Management — ${customer?.name || customerId}`;

      // Company card
      document.getElementById('companyName').textContent = customer?.name || '—';
      // Individual name (Stripe "name" on the Customer object can be your company — if you store
      // the contact person separately in metadata, show that; else fall back to name)
      const individual = customer?.metadata?.individual_name || '';
      const personLine = individual ? individual : '';
      document.getElementById('personLine').textContent = personLine || '';
      document.getElementById('companyEmail').textContent = customer?.email || '';

      // Payment methods (with default badge)
      const pmData = await fetch(`/.netlify/functions/list-payment-methods?customerId=${customerId}`).then(r=>r.json());
      const wrap = document.getElementById('pmList');
      wrap.innerHTML = '';
      const defaultPm = pmData.defaultPaymentMethod;

      if (!pmData.paymentMethods.length) {
        wrap.innerHTML = '<div class="muted">No payment methods on file.</div>';
      } else {
        pmData.paymentMethods.forEach(pm=>{
          const brand = capWord(pm.card.brand);
          const exp = new Date(pm.card.exp_year, pm.card.exp_month-1, 1);
          const expLabel = `Expires ${monthNames[exp.getMonth()]} ${exp.getFullYear()}`;

          const row = document.createElement('div');
          row.className = 'pm';
          const left = document.createElement('div');
          left.textContent = `${brand} •••• ${pm.card.last4}`;
          const right = document.createElement('div');
          right.textContent = expLabel;

          if (pm.id === defaultPm) {
            const badge = document.createElement('span');
            badge.className = 'default-badge';
            badge.textContent = 'Default';
            left.appendChild(badge);
          }

          row.append(left, right);
          wrap.append(row);
        });
      }

      // Payments (charges) — newest first
      const charges = await fetch(`/.netlify/functions/list-charges?customerId=${customerId}`).then(r=>r.json());
      const tbody = document.getElementById('paymentsBody');
      tbody.innerHTML = '';

      if (!Array.isArray(charges) || charges.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="muted">No payments found.</td></tr>`;
        return;
      }

      charges.forEach(ch => {
        const tr = document.createElement('tr');

        // date
        const tdDate = document.createElement('td');
        tdDate.className = 'nowrap';
        tdDate.textContent = fmtDate(ch.created);
        tr.appendChild(tdDate);

        // amount
        const tdAmt = document.createElement('td');
        tdAmt.textContent = fmtMoney(ch.amount, ch.currency);
        tr.appendChild(tdAmt);

        // status badge
        const tdStatus = document.createElement('td');
        const sb = document.createElement('span');
        sb.className = 'status-badge ' + (ch.status === 'succeeded' ? 'status-succeeded' : 'status-failed');
        sb.textContent = ch.status === 'succeeded' ? 'Paid' : 'Failed';
        tdStatus.appendChild(sb);
        tr.appendChild(tdStatus);

        // statement descriptor
        const tdStmt = document.createElement('td');
        tdStmt.textContent = ch.statement_descriptor || '—';
        tr.appendChild(tdStmt);

        // description
        const tdDesc = document.createElement('td');
        tdDesc.textContent = ch.description || (ch.failure_message ? `Failed: ${ch.failure_message}` : '—');
        tr.appendChild(tdDesc);

        // payment method
        const tdPm = document.createElement('td');
        const brand = capWord(ch.card?.brand || '');
        const last4 = ch.card?.last4 || '';
        tdPm.textContent = (brand && last4) ? `${brand} •••• ${last4}` : '—';
        tr.appendChild(tdPm);

        // receipt link
        const tdRec = document.createElement('td');
        if (ch.receipt_url) {
          const a = document.createElement('a');
          a.href = ch.receipt_url; a.target = '_blank';
          a.textContent = 'View';
          tdRec.appendChild(a);
        } else {
          tdRec.textContent = '—';
        }
        tr.appendChild(tdRec);

        tbody.appendChild(tr);
      });
    }

    loadCustomers();
  </script>
</body>
</html>
