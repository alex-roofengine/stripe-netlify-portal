<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outbound Management</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666; --border:#e7e7e7;
      --pill-green:#e8f7ee; --pill-green-text:#167e41;
      --pill-red:#fde8ea; --pill-red-text:#b4232d;
      --pill-open:#eef2ff; --pill-open-text:#3449d6;
      --default-blue:#0d6efd;
      --card-bg:#fff; --card-shadow:0 1px 2px rgba(0,0,0,.07);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:'Inter',sans-serif;color:var(--text);background:var(--bg)}
    h1,h2,h3{margin:0 0 .5rem 0}
    a{color:inherit}

    /* Sidebar */
    .sidebar{
      position:fixed; left:0; top:0; width:280px; height:100%;
      background:#000; color:#fff; padding:2em; display:flex; flex-direction:column
    }
    .sidebar img{width:150px; margin-bottom:1em}
    .sidebar h2{font-size:1.25em; line-height:1.3; margin-bottom:1em}
    .sidebar p#timestamp{margin-bottom:1em}
    .sidebar a.home{color:#fff; text-decoration:none; font-weight:600; margin-top:auto}

    /* Content */
    .content{margin-left:280px; padding:2em}
    .page-title{font-size:1.6rem; font-weight:700; margin-bottom:1rem}

    /* Cards / sections */
    .card{
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:12px; box-shadow:var(--card-shadow);
      padding:1.25rem; margin-bottom:1rem
    }
    .section-title{font-size:1.1rem; font-weight:700; margin-bottom:.75rem}

    /* Company block */
    .company-name{font-size:1.05rem; font-weight:700; margin-bottom:.25rem}
    .contact-line{color:var(--muted)}

    /* Payment methods */
    #pm-list{display:flex; flex-direction:column; gap:.5rem}
    .pm-row{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid var(--border); border-radius:8px; padding:.75rem 1rem
    }
    .pm-left{font-weight:600}
    .pm-right{color:#333}
    .default-badge{
      margin-left:.6rem; background:var(--default-blue); color:#fff;
      padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:700
    }

    /* Table */
    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse}
    thead th{
      text-align:left; font-size:.9rem; font-weight:700; color:#333;
      border-bottom:1px solid var(--border); padding:.75rem
    }
    tbody td{
      border-bottom:1px solid var(--border); padding:.75rem; vertical-align:top
    }
    .muted{color:var(--muted)}
    .status-pill{
      padding:2px 8px; border-radius:999px; font-size:.8rem; font-weight:700; display:inline-block
    }
    .paid{background:var(--pill-green); color:var(--pill-green-text)}
    .failed{background:var(--pill-red); color:var(--pill-red-text)}
    .open{background:var(--pill-open); color:var(--pill-open-text)}

    @media(max-width:768px){
      .sidebar{position:relative; width:100%; height:auto; padding:1em}
      .content{margin-left:0; padding:1em}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <img src="assets/logo.svg" alt="RoofEngine" />
    <h2>Welcome to the<br/>RoofEngine Billing Portal</h2>
    <p id="timestamp"></p>
    <a href="index.html" class="home">← Home</a>
  </div>

  <!-- Content -->
  <div class="content">
    <h1 class="page-title" id="page-title">Outbound Management</h1>

    <!-- Company -->
    <div class="card">
      <h3 class="section-title">Company</h3>
      <div class="company-name" id="company-name">—</div>
      <div class="contact-line" id="contact-line" class="muted">—</div>
    </div>

    <!-- Payment Methods -->
    <div class="card">
      <h3 class="section-title">Payment Methods</h3>
      <div id="pm-list"></div>
    </div>

    <!-- Billing History -->
    <div class="card">
      <h3 class="section-title">Billing History</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:140px;">Date</th>
              <th style="min-width:110px;">Amount</th>
              <th style="min-width:110px;">Status</th>
              <th style="min-width:180px;">Statement Descriptor</th>
              <th style="min-width:260px;">Description</th>
              <th style="min-width:180px;">Payment Method</th>
              <th style="min-width:160px;">Charge ID</th>
            </tr>
          </thead>
          <tbody id="invoice-tbody">
            <tr><td colspan="7" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Sidebar clock
    function updateTime(){
      const opts={ timeZone:'America/New_York', month:'long', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true };
      document.getElementById('timestamp').textContent =
        'Today is ' + new Intl.DateTimeFormat('en-US',opts).format(new Date()) + ' EST';
    }
    updateTime(); setInterval(updateTime,60000);

    // Helpers
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const params = new URLSearchParams(location.search);
    const customerId = params.get('customerId');

    // Bootstrap page
    (async function bootstrapDetails(){
      try{
        if(!customerId){ throw new Error('Missing customerId in URL'); }

        // 1) Load customer list and pick this one (uses your existing function)
        const customers = await fetch('/.netlify/functions/list-customers').then(r=>r.json());
        const c = customers.find(x=>x.id === customerId);
        if(!c){ throw new Error('Customer not found'); }

        // Page header
        document.getElementById('page-title').textContent =
          `Outbound Management — ${c.name || '(Unnamed)'}`;

        // Company block
        document.getElementById('company-name').textContent = c.name || '(Unnamed)';
        const individual = (c.metadata && c.metadata.contact_name) ? c.metadata.contact_name : null;
        const contactLineParts = [];
        if (individual) contactLineParts.push(individual);
        if (c.email) contactLineParts.push(c.email);
        document.getElementById('contact-line').textContent =
          contactLineParts.length ? contactLineParts.join(' • ') : '(No contact on file)';

        // 2) Payment methods + default
        const { paymentMethods, defaultPaymentMethod } =
          await fetch(`/.netlify/functions/list-payment-methods?customerId=${encodeURIComponent(customerId)}`)
            .then(r=>r.json());

        const pmWrap = document.getElementById('pm-list');
        pmWrap.innerHTML = '';
        if (!paymentMethods || !paymentMethods.length){
          const empty = document.createElement('div');
          empty.className='muted';
          empty.textContent='No cards on file.';
          pmWrap.appendChild(empty);
        } else {
          paymentMethods.forEach(pm=>{
            const brand = (pm.card?.brand || '').toString();
            const brandPretty = brand ? brand.charAt(0).toUpperCase() + brand.slice(1) : 'Card';
            const last4 = pm.card?.last4 || '••••';
            const exp = pm.card ? `Expires ${monthNames[(pm.card.exp_month||1)-1]} ${pm.card.exp_year}` : '';
            const isDefault = (pm.id === defaultPaymentMethod) || (pm.id === defaultPaymentMethod?.id);

            const row = document.createElement('div');
            row.className = 'pm-row';

            const left = document.createElement('div');
            left.className = 'pm-left';
            left.textContent = `${brandPretty} •••• ${last4}`;

            if (isDefault){
              const badge = document.createElement('span');
              badge.className = 'default-badge';
              badge.textContent = 'Default';
              left.appendChild(badge);
            }

            const right = document.createElement('div');
            right.className = 'pm-right';
            right.textContent = exp;

            row.append(left, right);
            pmWrap.appendChild(row);
          });
        }

        // 3) Billing history from Charges
        const charges = await fetch(`/.netlify/functions/list-charges?customerId=${encodeURIComponent(customerId)}`)
          .then(r=>r.json());

        const tbody = document.getElementById('invoice-tbody');
        tbody.innerHTML = '';

        if (!charges.length){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="7" class="muted">No charges found.</td>';
          tbody.appendChild(tr);
        } else {
          charges.forEach(ch=>{
            const date = new Date(ch.created*1000).toLocaleString('en-US', {
              month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit'
            });
            const amount = `$${Number(ch.amount).toLocaleString()} ${ch.currency}`;
            const pm = ch.payment_method
              ? `${(ch.payment_method.brand||'').toUpperCase()} •••• ${ch.payment_method.last4}`
              : '—';

            const pillClass = ch.status === 'succeeded' ? 'paid'
                              : ch.status === 'failed' ? 'failed'
                              : 'open';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${date}</td>
              <td>${amount}</td>
              <td><span class="status-pill ${pillClass}">${ch.status}</span></td>
              <td>${ch.statement_descriptor || '—'}</td>
              <td>${ch.description || '—'}</td>
              <td>${pm}</td>
              <td>${ch.id}</td>
            `;
            tbody.appendChild(tr);
          });
        }
      } catch(err){
        console.error(err);
        document.getElementById('company-name').textContent = 'Error loading details';
        const tbody = document.getElementById('invoice-tbody');
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Error: ${err.message}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
