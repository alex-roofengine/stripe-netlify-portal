<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Customer</title>
  <script>window.STRIPE_PUBLISHABLE_KEY='pk_test_…';</script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* Base layout same as index */
    body, html { margin: 0; padding: 0; height: 100%; }
    .sidebar { background: #000; color: #fff; width: 280px; position: fixed; height: 100%; padding: 2em; box-sizing: border-box; }
    .content { margin-left: 280px; padding: 2em; font-family: sans-serif; }
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { position: relative; width: 100%; height: auto; padding: 1em; }
      .content { margin-left: 0; padding: 1em; }
      #form-container > * { width: 100%; box-sizing: border-box; margin-bottom: .5em; }
      #submit { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" width="150" alt="RoofEngine" />
    <h2>Welcome to the<br/>RoofEngine Billing Portal</h2>
    <p id="timestamp"></p>
  </div>
  <div class="content">
    <h1>Billing</h1>
    <h2>Create a new customer:</h2>
    <div id="form-container">
      <label>Email: <input id="email" type="email" /></label><br />
      <label>Phone: <input id="phone" type="tel" /></label><br />
      <div id="card-element"></div>
      <button id="submit">Submit</button>
    </div>
    <div id="message"></div>
  </div>
  <script>
    const stripe = Stripe(window.STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    async function submit() {
      document.getElementById('submit').disabled = true;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const resp = await fetch('/.netlify/functions/create-customer', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, phone })
      });
      const { customerId, clientSecret } = await resp.json();
      const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret, { payment_method: { card } });
      if (error) return document.getElementById('message').textContent = error.message;
      await fetch('/.netlify/functions/attach-method', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId, paymentMethodId: setupIntent.payment_method })
      });
      document.getElementById('message').textContent = '✅ Customer created and card saved!';
    }
    document.getElementById('submit').addEventListener('click', submit);

    function updateTime() {
      const opts = { timeZone: 'America/New_York', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
      document.getElementById('timestamp').textContent = 'Today is ' + new Intl.DateTimeFormat('en-US', opts).format(new Date()) + ' EST';
    }
    updateTime(); setInterval(updateTime, 60000);
  </script>
</body>
</html>
