<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create New Customer</title>

  <!-- Inter Webfont -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Stripe.js -->
  <script>
    window.STRIPE_PUBLISHABLE_KEY = 'pk_test_51RaOwTH2B4qCgYPku1eH6qxmhVQTHprYixDOIs5ZQeH0aUxPnDbdjtdgG1mPr5l9aiqHZYoDaCl8ftViQaYucekw00rA3kMvP3';
  </script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body, html { margin:0; padding:0; font-family:'Inter',sans-serif; }
    .container { max-width:600px; margin:2em auto; padding:1em; }
    h1 { text-align:center; }
    form > div { margin-bottom:1em; }
    label { display:block; font-weight:600; margin-bottom:.5em; }
    input, button, .StripeElement { width:100%; padding:.75em; font-size:1em; margin-top:.25em; }
    .btn { border:none; border-radius:4px; font-weight:600; cursor:pointer; }
    .btn-green { background:#00D084; color:#fff; }
    .btn-orange{ background:#ff7800; color:#fff; }
    .actions { display:flex; gap:1em; margin-top:1em; }
    .actions button { flex:1; }
    #charge-date { max-width:200px; }
    .sublabel { font-size:.9em; color:#555; margin-top:.25em; }
    #loading-gif { margin:2em 0; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Create a New Customer</h1>
    <form id="customer-form">
      <div>
        <label for="company">Company Name</label>
        <input id="company" name="company" required />
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required />
      </div>
      <div>
        <label for="phone">Phone</label>
        <input id="phone" name="phone" required />
      </div>
      <div>
        <label for="address">Address</label>
        <input id="address" name="address" required />
      </div>
      <div>
        <label>Card Details</label>
        <div id="card-element" class="StripeElement"></div>
      </div>

      <!-- Action buttons -->
      <div class="actions">
        <button id="btn-charge-now" type="button" class="btn btn-green">Charge Now</button>
        <div style="flex:1;">
          <button id="btn-charge-later" type="button" class="btn btn-orange">Charge Later</button>
          <div class="sublabel">Charges scheduled in America/New_York time zone</div>
          <input id="charge-date" type="date" required />
        </div>
      </div>
    </form>

    <!-- Loading GIF -->
    <div id="loading-gif">
      <div class="tenor-gif-embed"
           data-postid="14552965973889090211"
           data-share-method="host"
           data-aspect-ratio="1"
           data-width="100%">
        <a href="https://tenor.com/view/loading-gif-gif-14552965973889090211">Loading</a>
        from <a href="https://tenor.com/search/loading+gif-stickers">Tenor</a>
      </div>
      <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
    </div>

    <p id="message" style="margin-top:1em; font-weight:600;"></p>
  </div>

  <script>
    const stripe = Stripe(window.STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const card = elements.create('card', { style:{ base:{ fontFamily:'Inter, sans-serif' } } });
    card.mount('#card-element');

    const form       = document.getElementById('customer-form');
    const btnNow     = document.getElementById('btn-charge-now');
    const btnLater   = document.getElementById('btn-charge-later');
    const dateInput  = document.getElementById('charge-date');
    const loadingGif = document.getElementById('loading-gif');
    const message    = document.getElementById('message');

    // Helper: show/hide loading
    function showLoading(show) {
      loadingGif.style.display = show ? 'block' : 'none';
    }
    function showMessage(text, color='#000') {
      message.textContent = text;
      message.style.color = color;
    }

    // 1) Create Customer on Stripe
    async function createCustomer(data) {
      const res = await fetch('/.netlify/functions/create-customer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const { customerId, error } = await res.json();
      if (error) throw new Error(error);
      return customerId;
    }

    // 2) Create SetupIntent
    async function getClientSecret(customerId) {
      const res = await fetch('/.netlify/functions/create-setup-intent', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ customerId })
      });
      const { clientSecret, error } = await res.json();
      if (error) throw new Error(error);
      console.log('üîë SetupIntent secret:', clientSecret);
      return clientSecret;
    }

    // 3) Confirm Card Setup
    async function confirmCard(clientSecret) {
      const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret, {
        payment_method: { card }
      });
      if (error) throw error;
      return setupIntent.payment_method;
    }

    // 4a) Charge Now
    btnNow.onclick = async () => {
      showMessage('', '#000'); showLoading(true);
      try {
        // gather form data
        const customerData = {
          name:      form.company.value,
          email:     form.email.value,
          phone:     form.phone.value,
          address:   form.address.value
        };
        const customerId     = await createCustomer(customerData);
        const clientSecret   = await getClientSecret(customerId);
        const paymentMethod  = await confirmCard(clientSecret);

        // call charge-now
        const res = await fetch('/.netlify/functions/charge-now', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            customerId,
            paymentMethodId: paymentMethod,
            productId:       'prod_KRxEr46XEWhQLm'
          })
        });
        const { invoice, error } = await res.json();
        if (error) throw new Error(error);
        showMessage('‚úÖ Charged successfully! Invoice: ' + invoice.id, 'green');
      } catch (err) {
        showMessage('‚ùå ' + err.message, 'red');
      } finally {
        showLoading(false);
      }
    };

    // 4b) Charge Later
    btnLater.onclick = async () => {
      showMessage('', '#000'); showLoading(true);
      try {
        const scheduledDate = dateInput.value;
        if (!scheduledDate) throw new Error('Please pick a date.');

        const customerData = {
          name:      form.company.value,
          email:     form.email.value,
          phone:     form.phone.value,
          address:   form.address.value
        };
        const customerId    = await createCustomer(customerData);
        const clientSecret  = await getClientSecret(customerId);
        const paymentMethod = await confirmCard(clientSecret);

        // call schedule-charge
        const res = await fetch('/.netlify/functions/schedule-charge', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            customerId,
            paymentMethodId: paymentMethod,
            productId:       'prod_KRxEr46XEWhQLm',
            date:            scheduledDate
          })
        });
        const { error } = await res.json();
        if (error) throw new Error(error);

        showMessage(`‚úÖ Scheduled! Will charge on ${scheduledDate} (America/New_York)`, 'green');
      } catch (err) {
        showMessage('‚ùå ' + err.message, 'red');
      } finally {
        showLoading(false);
      }
    };
  </script>
</body>
</html>
