<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create New Customer</title>

  <!-- Inter Webfont -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Stripe.js (library only; key injected below) -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    * { box-sizing: border-box; }
    body, html { margin:0; padding:0; height:100%; font-family:'Inter',sans-serif; }
    .sidebar {
      position:fixed; top:0; left:0; width:280px; height:100%;
      background:#000; color:#fff; padding:2em; display:flex; flex-direction:column;
    }
    .sidebar img { width:150px; margin-bottom:1em; }
    .sidebar h2 { font-size:1.25em; margin:0 0 1em; line-height:1.3; }
    .sidebar p, .sidebar a { margin:0 0 1em; color:#fff; text-decoration:none; }
    .content { margin-left:280px; padding:2em; }
    h1 { margin-bottom:1em; }

    /* Duplicate warning box */
    #dup-alert {
      display:none;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 4px;
    }

    /* Two-column form */
    #cust-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1em;
    }
    #cust-form .full { grid-column: 1 / -1; }

    label { font-weight:600; display:block; margin-bottom:.5em; }
    input, .StripeElement { width:100%; padding:.75em; font-size:1em; }

    #charge-date {
      display:none; width:250px; padding:.5em;
    }
    #card-element {
      border:1px solid #ccc; border-radius:4px; padding:12px;
    }

    .radio-group {
      display:flex; gap:1em;
    }
    .radio-group .option {
      flex:1; text-align:center;
    }
    .radio-group .option input { display:none; }
    .radio-group .option span {
      display:inline-block; padding:.5em 1em;
      border:1px solid #ccc; border-radius:4px; cursor:pointer;
    }
    .radio-group .option.now input:checked + span {
      background:#00D084; color:#fff; border-color:#00D084;
    }
    .radio-group .option.later input:checked + span {
      background:#ff7800; color:#fff; border-color:#ff7800;
    }

    button, .btn {
      padding:.75em 1.5em; font-weight:600;
      border:none; border-radius:6px; cursor:pointer;
    }
    #submit-btn {
      background:#007bff; color:#fff; width:100%; margin-top:1em;
    }
    #loading {
      display:none; text-align:center; margin-top:2em;
    }
    #confirm-modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:none;
      align-items:center; justify-content:center;
    }
    #confirm-box {
      background:#fff; padding:2em; border-radius:8px;
      max-width:400px; text-align:center;
    }
    #confirm-msg { margin-bottom:1em; }
    #countdown { font-size:1.2em; margin-bottom:1em; }
    #modal-ok { background:#00D084; color:#fff; margin-right:1em; }
    #modal-cancel { background:#dc3545; color:#fff; }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="assets/logo.svg" alt="RoofEngine Logo" />
    <h2>RoofEngine<br/>Billing Portal</h2>
    <p id="timestamp"></p>
    <a href="index.html">← Home</a>
  </div>

  <div class="content">
    <h1>Create New Customer</h1>

    <!-- Duplicate warning -->
    <div id="dup-alert"></div>

    <!-- Form -->
    <form id="cust-form">
      <div>
        <label for="company">Company Name</label>
        <input id="company" name="company" required/>
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" type="email" name="email" required/>
      </div>
      <div>
        <label for="phone">Phone</label>
        <input id="phone" name="phone" required/>
      </div>
      <div>
        <label for="line1">Street Address</label>
        <input id="line1" name="line1" placeholder="123 Main St" required/>
      </div>
      <div>
        <label for="city">City</label>
        <input id="city" name="city" required/>
      </div>
      <div>
        <label for="state">State</label>
        <input id="state" name="state" required/>
      </div>
      <div class="full">
        <label for="postal_code">Zip Code</label>
        <input id="postal_code" name="postal_code" required/>
      </div>
      <div class="full">
        <div class="radio-group">
          <label class="option now">
            <input type="radio" name="chargeOption" value="now" required/>
            <span>Charge Now</span>
          </label>
          <label class="option later">
            <input type="radio" name="chargeOption" value="later"/>
            <span>Charge Later</span>
          </label>
        </div>
        <input id="charge-date" type="date"/>
      </div>
      <div class="full">
        <label>Card Details</label>
        <div id="card-element" class="StripeElement"></div>
      </div>
      <div class="full">
        <button id="submit-btn" type="submit">Submit</button>
      </div>
    </form>

    <!-- Loading spinner -->
    <div id="loading">
      <video
        src="assets/vecteezy_loading-circle-icon-loading-gif-loading-screen-gif-loading_8202381.mp4"
        autoplay loop muted
        width="50" height="50"
      ></video>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal">
    <div id="confirm-box">
      <p id="confirm-msg"></p>
      <p id="countdown">20</p>
      <button id="modal-ok">OK</button>
      <button id="modal-cancel">Cancel</button>
    </div>
  </div>

  <script>
    // Clock
    function updateTime(){
      const opts={ timeZone:'America/New_York',
                   month:'long', day:'numeric',
                   hour:'numeric', minute:'2-digit',
                   hour12:true };
      document.getElementById('timestamp').textContent =
        'Today is ' +
        new Intl.DateTimeFormat('en-US',opts).format(new Date()) +
        ' EST';
    }
    updateTime(); setInterval(updateTime,60000);

    async function initApp(){
      // 1) fetch publishable key
      const keyRes = await fetch('/.netlify/functions/get-publishable-key');
      const { publishableKey } = await keyRes.json();
      const stripe = Stripe(publishableKey);
      const elements = stripe.elements();
      const cardEl = elements.create('card',{ style:{ base:{ fontFamily:'Inter, sans-serif' } } });
      cardEl.mount('#card-element');

      // helpers
      const loading = document.getElementById('loading');
      const dupAlert = document.getElementById('dup-alert');
      function showLoader(on){ loading.style.display = on?'block':'none'; }

      const form      = document.getElementById('cust-form');
      const dateInput = document.getElementById('charge-date');
      const modal     = document.getElementById('confirm-modal');
      const msg       = document.getElementById('confirm-msg');
      const cd        = document.getElementById('countdown');
      const okBtn     = document.getElementById('modal-ok');
      const cancelBtn = document.getElementById('modal-cancel');

      // show/hide date
      form.chargeOption.forEach(radio=>{
        radio.onchange = ()=> dateInput.style.display = radio.value==='later'?'block':'none';
      });

      // confirmation modal
      let countdownInterval, resolveFn, rejectFn;
      function showConfirm(text){
        msg.textContent = text;
        let t=20; cd.textContent = t;
        modal.style.display = 'flex';
        return new Promise((res, rej)=>{
          resolveFn=res; rejectFn=rej;
          clearInterval(countdownInterval);
          countdownInterval=setInterval(()=>{
            t--; cd.textContent=t;
            if(t<=0){
              clearInterval(countdownInterval);
              modal.style.display='none';
              rej(new Error('Timed out'));
            }
          },1000);
        });
      }
      okBtn.onclick     = ()=>{ clearInterval(countdownInterval); modal.style.display='none'; resolveFn(); };
      cancelBtn.onclick = ()=>{ clearInterval(countdownInterval); modal.style.display='none'; rejectFn(new Error('Cancelled')); };

      // main submit
      form.onsubmit = async e=>{
        e.preventDefault();
        dupAlert.style.display = 'none';

        // 2) check duplicate by email
        const email = form.email.value.trim();
        const dupRes = await fetch(`/.netlify/functions/check-duplicate?email=${encodeURIComponent(email)}`);
        const { exists, customerId: dupId, name: dupName } = await dupRes.json();
        if (exists) {
          dupAlert.innerHTML = `
            A customer already exists for "${dupName}" (${email}).<br/>
            <button id="go-update">Go update their billing details</button>
          `;
          dupAlert.style.display = 'block';
          document.getElementById('go-update').onclick = () => {
            location.href = `update-details.html?customerId=${dupId}`;
          };
          return;
        }

        // 3) then proceed with create → setup → confirm → charge
        showLoader(true);
        try {
          // Create customer
          const createRes = await fetch('/.netlify/functions/create-customer',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              name:        form.company.value,
              email,
              phone:       form.phone.value,
              line1:       form.line1.value,
              city:        form.city.value,
              state:       form.state.value,
              postal_code: form.postal_code.value
            })
          });
          const { customerId, error:cErr } = await createRes.json();
          if (cErr) throw new Error(cErr);

          // SetupIntent
          const siRes = await fetch('/.netlify/functions/create-setup-intent',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ customerId })
          });
          const { clientSecret, error:siErr } = await siRes.json();
          if (siErr) throw new Error(siErr);

          // Confirm card
          const { setupIntent, error:ciErr } = await stripe.confirmCardSetup(
            clientSecret, { payment_method:{ card: cardEl } }
          );
          if (ciErr) throw ciErr;
          const pmId = setupIntent.payment_method;

          // Retrieve PM
          const pmRes = await fetch(`/.netlify/functions/retrieve-payment-method?paymentMethodId=${pmId}`);
          const { card, error:pmErr } = await pmRes.json();
          if (pmErr) throw new Error(pmErr);
          const last4 = card.last4;

          // Branch
          const opt = form.chargeOption.value;
          if (opt==='now') {
            await showConfirm(`We will now charge the card ending in ${last4} the amount of $2,000 USD. Click OK.`);
            const chRes = await fetch('/.netlify/functions/charge-now',{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ customerId, paymentMethodId:pmId, productId:'prod_KRxEr46XEWhQLm' })
            });
            const { invoice, error:chErr } = await chRes.json();
            if (chErr) throw new Error(chErr);
            alert('✅ Charged! Invoice: '+invoice.id);
          } else {
            if (!dateInput.value) throw new Error('Please pick a date.');
            const dateStr = new Date(dateInput.value+'T09:00:00-04:00')
              .toLocaleString('en-US',{ timeZone:'America/New_York', dateStyle:'long', timeStyle:'short' });
            await showConfirm(`We will charge the card ending in ${last4} on ${dateStr}. Click OK.`);
            const scRes = await fetch('/.netlify/functions/schedule-charge',{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ customerId, paymentMethodId:pmId, productId:'prod_KRxEr46XEWhQLm', date:dateInput.value })
            });
            const { error:scErr } = await scRes.json();
            if (scErr) throw new Error(scErr);
            alert('✅ Charge scheduled for '+dateStr);
          }

          // 4) Clear form on success
          form.reset();
        } catch(err) {
          alert('❌ '+err.message);
        } finally {
          showLoader(false);
        }
      };
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
