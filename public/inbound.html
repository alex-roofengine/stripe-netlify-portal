<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbound Client Billing</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body,html{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif;background:#fafafa;color:#111}
    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:1rem;background:#000;color:#fff;padding:.85rem 1.25rem;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:.75rem;min-width:280px}
    .brand img{height:28px}
    .brand .title strong{display:block;line-height:1}
    .badge-inbound{background:#F3E72F;color:#111;font-weight:800;border-radius:8px;padding:.2rem .5rem;margin-left:.4rem;display:inline-block}
    .spacer{flex:1}
    .clock{color:#ddd;font-weight:600;min-width:max-content}
    .home{color:#fff;text-decoration:none;border:2px solid #b50000;background:#cc0000;border-radius:10px;padding:.7rem 1rem;font-weight:800}
    #progress{height:3px;background:#F3E72F;width:0;transition:width .25s ease;position:relative;z-index:19}
    .progress-anim{position:absolute;left:0;top:0;height:3px;width:100%;background:linear-gradient(90deg,rgba(243,231,47,0) 0%,rgba(243,231,47,.9) 50%,rgba(243,231,47,0) 100%);background-size:200% 100%;animation:slide 1s linear infinite;opacity:0}
    .progress-anim[data-on="true"]{opacity:1}
    @keyframes slide{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .wrap{max-width:1200px;margin:0 auto;padding:1.25rem}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:1.25rem}
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:1rem 1.25rem}
    .card h2{margin:.25rem 0 1rem;font-size:1.15rem}
    .muted{color:#666}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    select,input[type="date"],input[type="number"],input[type="text"]{padding:.65rem .75rem;border:1px solid #d6d6d6;border-radius:8px;background:#fff;font-size:1rem}
    select{min-width:300px}
    label{display:block;font-weight:600;margin:.25rem 0 .35rem}
    .choices{display:flex;gap:.75rem}
    .pill{border:1px solid #d6d6d6;border-radius:999px;padding:.45rem .9rem;cursor:pointer;font-weight:700;user-select:none}
    .pill[data-active="true"]{background:#111;color:#fff;border-color:#111}
    .pill.green[data-active="true"]{background:#00D084;border-color:#00D084}
    .pill.orange[data-active="true"]{background:#ff7800;border-color:#ff7800}
    #new-card{border:1px solid #d6d6d6;border-radius:8px;padding:12px;margin-top:.25rem}
    .pm{display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;border-radius:10px;padding:.65rem .75rem;margin:.5rem 0}
    .pm .meta{display:flex;align-items:center;gap:.5rem}
    .badge{display:inline-block;border-radius:6px;padding:2px 6px;font-size:.8rem;font-weight:800}
    .badge.default{background:#007bff;color:#fff}
    .badge.recent{background:#16a34a;color:#fff}
    .pm small{color:#666}
    .link-btn{border:1px solid #ddd;background:#fff;border-radius:8px;padding:.45rem .75rem;cursor:pointer;font-weight:700}
    .tip{background:#fff9d6;border:2px dashed #e8d269;border-radius:10px;padding:.6rem .75rem;color:#5c4a00;margin-top:.6rem;font-size:.95rem}
    .tip ul{margin:.25rem 0 0 .75rem;padding:0}
    .tip li{margin:.25rem 0}
    #submit{display:block;width:100%;border-radius:10px;padding:.9rem 1.2rem;border:2px solid #00D084;background:#00D084;color:#fff;font-weight:800;text-align:center}
    #submit:hover{filter:brightness(0.95)}
    #resultMsg{display:inline-block;margin-top:.6rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    th{font-weight:700}
    .nowrap{white-space:nowrap}
    .status{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .status.ok{background:#e8f7ee;color:#1a7f37}
    .status.fail{background:#fde8ea;color:#b42318}
    #pageLoading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9998;background:rgba(0,208,132,0.9);color:#fff;font-weight:900;font-size:1.2rem}
    #pageLoading .box{background:transparent;border:2px dashed #fff;border-radius:12px;padding:1rem 1.25rem}
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .loader{width:58px;height:58px;border-radius:50%;border:6px solid #fff;border-top-color:transparent;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:980px){.grid{grid-template-columns:1fr}select{min-width:unset;width:100%}}
    .error-inline{color:#b42318;font-weight:700}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="assets/logo.svg" alt="RoofEngine" />
      <div class="title">
        <strong>RoofEngine Billing Portal</strong>
        <span class="badge-inbound">(Inbound)</span>
      </div>
    </div>
    <div class="spacer"></div>
    <div id="clock" class="clock">—</div>
    <a class="home" href="index.html">← Home</a>
  </header>
  <div id="progress"><div id="progressAnim" class="progress-anim"></div></div>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <h2>Charge an Inbound Client</h2>

        <div class="row" style="margin-bottom:.5rem">
          <label for="custSel" style="margin:0">Select client</label>
          <input id="custSearch" type="text" placeholder="Type to filter clients…" style="display:none;margin-right:.5rem" />
          <select id="custSel">
            <option value="" disabled selected>Loading customers…</option>
          </select>
          <button id="retryBtn" class="link-btn" style="display:none">Retry</button>
          <span class="muted" id="selHelp">If you don't see a client in this list, please contact tech support.</span>
        </div>

        <div id="chargeSection" style="display:none">
          <div class="card" style="margin-top:1rem">
            <div>
              <label>Payment Method</label>
              <div id="pmPicker"></div>
              <div id="noPmHint" class="muted" style="display:none;margin-top:.25rem">No card on file. Add a new card below.</div>
              <div id="addNewBtnWrap" class="row" style="display:none;margin-top:.5rem">
                <button id="showAddCard" class="link-btn">➕ Add a New Card</button>
              </div>
              <div id="newCardWrap" style="display:none;margin-top:.5rem">
                <div id="new-card"></div>
                <div class="row" style="margin-top:.6rem">
                  <button id="saveCard" class="link-btn">Save card & set default</button>
                  <span id="saveCardMsg" class="muted"></span>
                </div>
              </div>
            </div>

            <div style="margin-top:1rem">
              <label for="amount">Amount (USD)</label>
              <input type="number" id="amount" min="1" step="1" placeholder="2500" required>
            </div>

            <input type="number" id="amount" min="1" step="1" placeholder="2500" required>
            <div id="amountHint" class="amount-hint" style="font-size:.9rem;color:#555;margin-top:.35rem"></div>


            <!-- Description (UPDATED AS REQUESTED) -->
            <div style="margin-top:.6rem">
              <label for="descSel">Description</label>
              <select id="descSel" required>
                <option value="" disabled selected>Select a description…</option>
                <option value="inbound_retainer">Inbound Retainer</option>
                <option value="inbound_adspend">Inbound Ad Spend</option>
                <option value="__other__">Other, please type in the description…</option>
              </select>
              <input id="descOther" type="text" placeholder="Enter custom description…" style="display:none;margin-top:.5rem">
              <div class="tip">
                <ul>
                  <li>All charges under Inbound will show up like <strong>"Nov 2025 TypeOfCharge - Client Name"</strong></li>
                  <li><strong>Inbound Retainer</strong> → one-time charge for retainer</li>
                  <li><strong>Inbound Ad Spend</strong> → one-time charge for ad spend</li>
                  <li><strong>“Other”</strong> → special cases / top-ups</li>
                </ul>
              </div>
            </div>

            <div style="margin-top:1rem">
              <label>Charge timing</label>
              <div class="choices">
                <div class="pill green" data-role="when" data-val="now" data-active="true">Charge Now</div>
                <div class="pill orange" data-role="when" data-val="later">Charge Later</div>
              </div>
              <div id="laterBox" style="margin-top:.6rem;display:none">
                <label for="chargeDate" style="display:inline">Charge date</label>
                <input type="date" id="chargeDate">
                <span class="muted" style="margin-left:.35rem">Charged 9:00 AM America/New_York</span>
              </div>
            </div>

            <div style="margin-top:1.25rem">
              <button id="submit" type="button">Submit Charge</button>
              <div id="resultMsg" class="muted"></div>
            </div>
          </div>

          <div class="muted" style="margin-top:1rem">
            Note: This tool charges <strong>credit cards only</strong> or verified <strong>ACH bank accounts</strong>. ACH can take up to 7 business days to settle. For ACH setup or questions, contact billing.
          </div>
        </div>
      </section>

      <aside class="card">
        <h2 id="panelTitle">Client</h2>
        <div style="margin-bottom:1rem">
          <div id="coName" style="font-weight:700">—</div>
          <div id="contactName" class="muted">—</div>
          <div id="coEmail" class="muted">—</div>
        </div>

        <div style="margin:.75rem 0">
          <strong>Payment Methods</strong>
          <div id="pmList"></div>
        </div>

        <div style="margin-top:1rem">
          <strong>Recent Payments</strong>
          <table style="margin-top:.4rem">
            <thead>
              <tr>
                <th>Date</th><th>Description</th><th class="nowrap">Amount</th><th>Status</th><th>Receipt</th>
              </tr>
            </thead>
            <tbody id="histBody">
              <tr><td colspan="5" class="muted">Select a client to load history.</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>

  <div id="pageLoading"><div class="box">Loading, Please Wait!</div></div>
  <div id="loadingOverlay"><div class="loader" aria-label="Processing…"></div></div>

  <script src="https://js.stripe.com/v3"></script>
  <script type="module">
    import { isOutbound, isInbound, filterForPage } from "./js/filters.js";
    window.PAGE_FILTER_NAME = "inbound";
    window.IS_OUTBOUND = isOutbound;
    window.IS_INBOUND = isInbound;
    window.filterForPage = filterForPage;
  </script>
  <script>
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const fmtDate = unix => { const d = new Date(unix*1000); return `${monthNames[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; };
    const setProgress = v => { document.getElementById('progress').style.width = v+'%'; };
    const setProgressAnim = on => { const el = document.getElementById('progressAnim'); if (el) el.setAttribute('data-on', on ? 'true':'false'); };
    const showOverlay = on => { document.getElementById('loadingOverlay').style.display = on ? 'flex' : 'none'; };
    const showPageLoading = on => { document.getElementById('pageLoading').style.display = on ? 'flex' : 'none'; };

    function tickClock(){
      const now = new Date();
      const fmt = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        month: 'long', day: 'numeric',
        hour: 'numeric', minute: '2-digit',
        hour12: true,
        timeZoneName: 'short'
      });
      const txt = fmt.format(now);
      const el = document.getElementById('clock');
      if (el) el.textContent = `Today is ${txt}`;
    }
    tickClock(); setInterval(tickClock, 60000);

    let stripe, elements, cardEl;
    let customers = [];
    let selectedCustomer = null;
    let defaultPmId = null;
    let currentWhen = 'now';

    const BASE_INBOUND_DESCRIPTOR = "ROOFENGINE INBOUND";
    const PRODUCT_ID = "prod_TC1NUvIsUykBKs";
    const NET_TIMEOUT_MS = 10000;
    const CACHE_TTL_MS = 5 * 60 * 1000;

    function normalizeAch(pm = {}){
      const bank = pm.us_bank_account || pm.bank || {};
      const raw = bank.status || bank.verification_status || (bank.financial_connections && bank.financial_connections.verification_status) || null;
      const verified = pm.verified === true || raw === 'verified' || raw === 'instant_verified' || raw === 'succeeded';
      return { bank_name: bank.bank_name || pm.bank_name || 'Bank Account', last4: bank.last4 || pm.last4 || '••••', account_type: bank.account_type || null, status: raw, verified };
    }
    function getCurrentCustomerId(){
      if (selectedCustomer && selectedCustomer.id) return selectedCustomer.id;
      const sel = document.getElementById('custSel');
      return sel && sel.value ? sel.value : null;
    }
    function getSelectedClientName(){
      const cid = getCurrentCustomerId();
      const c = (customers || []).find(x=>x.id===cid) || selectedCustomer || {};
      return c.name || c.email || c.id || 'Client';
    }
    function currentMonthYearLabel(){
      const d = new Date();
      return `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
    }
    function cacheKey(){ return `re_customers_${window.PAGE_FILTER_NAME||'unknown'}`; }
    function saveCustomersCache(list){ try { sessionStorage.setItem(cacheKey(), JSON.stringify({ t: Date.now(), data: list })); } catch {} }
    function readCustomersCache(){ try { const raw = sessionStorage.getItem(cacheKey()); if (!raw) return null; const obj = JSON.parse(raw); if (!obj || !Array.isArray(obj.data)) return null; if (Date.now() - obj.t > CACHE_TTL_MS) return null; return obj.data; } catch { return null; } }
    function fetchWithTimeout(url, options={}, ms=NET_TIMEOUT_MS){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), ms);
      const merged = { ...options, signal: ctrl.signal };
      return fetch(url, merged).finally(()=>clearTimeout(id));
    }

function computeTotalCents(baseDollars, choice){
  const cents = Math.round((baseDollars || 0) * 100);
  if (choice === 'inbound_adspend') {
    return Math.round(cents * 1.035); // add 3.5%
  }
  return cents;
}
function computeTotalDollars(baseDollars, choice){
  return computeTotalCents(baseDollars, choice) / 100;
}
function updateAmountHint(){
  const choice = $('#descSel').value;
  const base = parseFloat($('#amount').value) || 0;
  const total = computeTotalDollars(base, choice);
  const hint = $('#amountHint');
  if (!hint) return;
  if (choice === 'inbound_adspend' && base > 0){
    const fee = (total - base).toFixed(2);
    hint.textContent = `Includes 3.5% processing fee (+$${fee}). Total charge: $${total.toFixed(2)}`;
  } else {
    hint.textContent = '';
  }
}



    
    (async function init(){
      try{
        setProgress(5); setProgressAnim(true);
        const customersTask = loadCustomersAndFill();
        const stripeTask = (async () => {
          let publishableKey;
          try { ({ publishableKey } = await fetchWithTimeout('/.netlify/functions/get-publishable-key',{cache:'no-store'}, NET_TIMEOUT_MS).then(r=>r.json())); }
          catch { ({ publishableKey } = await fetchWithTimeout('/.netlify/functions/public-keys',{cache:'no-store'}, NET_TIMEOUT_MS).then(r=>r.json())); }
          stripe = Stripe(publishableKey);
          elements = stripe.elements();
        })();
        bindUI();
        await Promise.allSettled([customersTask, stripeTask]);
        setProgress(100); setTimeout(()=>{ setProgress(0); setProgressAnim(false); }, 800);
      }catch(e){
        console.error(e);
        alert('Failed to initialize billing portal. Please refresh.');
        setProgressAnim(false);
      }
    })();

    function bindUI(){
      document.getElementById('descSel').addEventListener('change', ()=>{
        document.getElementById('descOther').style.display = (document.getElementById('descSel').value === '__other__') ? 'block' : 'none';
      });
      document.querySelectorAll('[data-role="when"]').forEach(p=>{
        p.addEventListener('click', ()=>{
          document.querySelectorAll('[data-role="when"]').forEach(x=>x.setAttribute('data-active','false'));
          p.setAttribute('data-active','true');
          currentWhen = p.dataset.val;
          document.getElementById('laterBox').style.display = currentWhen==='later' ? 'block' : 'none';
        });
      });
      document.getElementById('submit').addEventListener('click', submitCharge);
      document.getElementById('custSel').addEventListener('change', async ()=>{
        if (document.getElementById('chargeSection').style.display!=='block'){
          document.getElementById('chargeSection').style.display = 'block';
        }
        showPageLoading(true);
        await onSelectCustomer(document.getElementById('custSel').value);
        showPageLoading(false);
      });
      document.getElementById('showAddCard').addEventListener('click', ()=>{
        document.getElementById('newCardWrap').style.display = 'block';
        mountCardElement();
      });
      const search = document.getElementById('custSearch');
      if (search) search.style.display = 'inline-block';
      if (search) search.addEventListener('input', ()=>filterCustomerOptions(search.value));
      const retry = document.getElementById('retryBtn');
      if (retry) retry.addEventListener('click', ()=>{ loadCustomersAndFill(true); });
      $('#descSel').addEventListener('change', ()=>{
  $('#descOther').style.display = ($('#descSel').value === '__other__') ? 'block' : 'none';
  updateAmountHint();
});
$('#amount').addEventListener('input', updateAmountHint);

    }

    function filterCustomerOptions(q=''){
      q = (q || '').toLowerCase().trim();
      const sel = document.getElementById('custSel'); if (!sel) return;
      sel.innerHTML = '<option value="" disabled selected>Select a client…</option>';
      (customers || []).forEach(c=>{
        const name = (c.name || '').toLowerCase();
        const email = (c.email || '').toLowerCase();
        if (!q || name.includes(q) || email.includes(q)) {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name || c.email || c.id;
          sel.appendChild(opt);
        }
      });
    }

    async function loadCustomersAndFill(isRetry=false){
      try{
        setProgress(15);
        const cached = readCustomersCache();
        if (cached && !isRetry) {
          customers = cached;
          filterCustomerOptions(document.getElementById('custSearch')?.value || '');
        } else {
          document.getElementById('custSel').innerHTML = '<option value="" disabled selected>Loading customers…</option>';
        }
        setProgress(35);
        let payload, errorMsg = '';
        try {
          payload = await fetchWithTimeout('/.netlify/functions/list-customers?type=inbound', { cache: 'no-store' }, NET_TIMEOUT_MS).then(r=>r.json());
          if (!Array.isArray(payload)) throw new Error('Bad payload');
        } catch(e1) {
          errorMsg = e1?.message || String(e1);
          try {
            payload = await fetchWithTimeout('/.netlify/functions/list-customers?type=inbound', { cache: 'no-store' }, NET_TIMEOUT_MS).then(r=>r.json());
            if (!Array.isArray(payload)) throw new Error('Bad payload');
          } catch(e2) {
            errorMsg += ' | ' + (e2?.message || String(e2));
            throw new Error(errorMsg);
          }
        }
        setProgress(70);
        const sel = document.getElementById('custSel');
        customers = window.filterForPage ? filterForPage(payload, window.PAGE_FILTER_NAME) : payload;
        filterCustomerOptions(document.getElementById('custSearch')?.value || '');
        saveCustomersCache(customers);
        setProgress(90);
        const urlId = new URLSearchParams(location.search).get('customerId');
        if (urlId && customers.find(x=>x.id===urlId)) { sel.value = urlId; document.getElementById('chargeSection').style.display='block'; await onSelectCustomer(urlId); }
        document.getElementById('retryBtn').style.display = 'none';
        document.getElementById('selHelp').classList.remove('error-inline');
      } catch(err) {
        console.error('[loadCustomersAndFill]', err);
        const sel = document.getElementById('custSel');
        sel.innerHTML = '<option value="" disabled selected>Failed to load customers</option>';
        document.getElementById('selHelp').textContent = 'Could not load customers. Check your connection or try again.';
        document.getElementById('selHelp').classList.add('error-inline');
        document.getElementById('retryBtn').style.display = 'inline-block';
      }
    }

    async function onSelectCustomer(id){
      selectedCustomer = customers.find(c=>c.id===id) || { id };
      await refreshRightPanel();
      await refreshPaymentPickers();
    }

    async function refreshRightPanel(){
      const cid=getCurrentCustomerId();
      if(!cid){
        document.getElementById('panelTitle').textContent='Client';
        document.getElementById('coName').textContent='—';
        document.getElementById('contactName').textContent='—';
        document.getElementById('coEmail').textContent='—';
        document.getElementById('pmList').innerHTML='';
        document.getElementById('histBody').innerHTML='<tr><td colspan="5" class="muted">Select a client to load history.</td></tr>';
        return;
      }
      const selc = customers.find(c=>c.id===cid) || selectedCustomer || {};
      document.getElementById('panelTitle').textContent = `Client — ${selc.name || cid}`;
      document.getElementById('coName').textContent = selc.name || '—';
      document.getElementById('contactName').textContent = selc.metadata?.contact_name || '—';
      document.getElementById('coEmail').textContent = selc.email || '—';

      const pmData = await fetchWithTimeout(`/.netlify/functions/list-payment-methods?customerId=${cid}`, { cache:'no-store' }, NET_TIMEOUT_MS).then(r=>r.json());
      defaultPmId = pmData.defaultPaymentMethod || null;
      const listEl = document.getElementById('pmList'); listEl.innerHTML = '';

      const pms = Array.isArray(pmData.paymentMethods) ? pmData.paymentMethods : [];
      if (!pms.length){
        listEl.innerHTML = '<div class="muted">No payment methods on file.</div>';
      } else {
        pms.forEach(pm=>{
          let left='', right='';
          if (pm.type === 'card'){
            const exp=(pm.card?.exp_month&&pm.card?.exp_year)?`Expires ${monthNames[(pm.card.exp_month||1)-1]} ${pm.card.exp_year}`:'';
            left = `${(pm.card?.brand||pm.brand||'Card').toString().replace(/^./,c=>c.toUpperCase())} •••• ${pm.card?.last4 || pm.last4 || '••••'}${pm.id===defaultPmId?' <span class="badge default">Default</span>':''}`;
            right = `<small>${exp}</small>`;
          } else if (pm.type === 'us_bank_account'){
            const ach=normalizeAch(pm); const acctType=ach.account_type?` (${ach.account_type})`:'';
            left = `${ach.bank_name} •••• ${ach.last4}${acctType}${pm.id===defaultPmId && ach.verified?' <span class="badge default">Default</span>':''} <span class="badge" style="background:#0ea5e9;color:#fff">ACH</span>`;
            right = `<small>${ach.verified?'Verified bank account':'Not verified'}</small>`;
          }
          const row=document.createElement('div'); row.className='pm';
          const l=document.createElement('div'); l.className='meta'; l.innerHTML=left;
          const r=document.createElement('div'); r.innerHTML=right;
          row.append(l,r); listEl.append(row);
        });
      }

      const charges = await fetchWithTimeout(`/.netlify/functions/list-charges?customerId=${cid}`, { cache:'no-store' }, NET_TIMEOUT_MS).then(r=>r.json());
      const body = document.getElementById('histBody'); body.innerHTML='';
      if (!charges?.length){
        body.innerHTML = '<tr><td colspan="5" class="muted">No payments found.</td></tr>';
      } else {
        charges.slice(0,5).forEach(ch=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap">${fmtDate(ch.created)}</td>
            <td>${ch.description||'—'}</td>
            <td class="nowrap">${typeof ch.amount === 'number' ? new Intl.NumberFormat('en-US',{style:'currency',currency:(ch.currency||'usd').toUpperCase()}).format(ch.amount/100) : '—'}</td>
            <td>${ch.status==='succeeded'?'<span class="status ok">Paid</span>':'<span class="status fail">Failed</span>'}</td>
            <td>${ch.receipt_url?`<a target="_blank" href="${ch.receipt_url}">Receipt</a>`:'—'}</td>
          `;
          body.appendChild(tr);
        });
      }
    }

    function mountCardElement(){
      if (cardEl) return;
      cardEl = elements.create('card',{ style:{ base:{ fontFamily:'Inter, sans-serif' } } });
      cardEl.mount('#new-card');
    }

    async function refreshPaymentPickers(){
      const wrap=document.getElementById('pmPicker'); wrap.innerHTML='';
      document.getElementById('addNewBtnWrap').style.display='none';
      document.getElementById('newCardWrap').style.display='none';

      const cid=getCurrentCustomerId();
      if (!cid){
        wrap.innerHTML='<div class="muted">Select a client to load payment methods.</div>';
        return;
      }

      const data = await fetchWithTimeout(`/.netlify/functions/list-payment-methods?customerId=${cid}`, { cache:'no-store' }, NET_TIMEOUT_MS).then(r=>r.json());
      defaultPmId = data.defaultPaymentMethod || null;

      const pms = data.paymentMethods || [];
      const cards=pms.filter(p=>p.type==='card');
      const banks=pms.filter(p=>p.type==='us_bank_account');

      if (!cards.length && !banks.length){
        document.getElementById('noPmHint').style.display='block';
        document.getElementById('newCardWrap').style.display='block';
        mountCardElement();
        return;
      }
      document.getElementById('noPmHint').style.display='none';
      document.getElementById('addNewBtnWrap').style.display='flex';

      // Cards
      cards.forEach(pm=>{
        const id=`pick-${pm.id}`;
        const label=document.createElement('label'); label.className='pm';
        const expTxt=pm.card?.exp_month&&pm.card?.exp_year?`Expires ${monthNames[(pm.card.exp_month||1)-1]} ${pm.card.exp_year}`:'';
        label.innerHTML = `<div class="meta"><input type="radio" name="pmPick" id="${id}" value="${pm.id}" ${pm.id===defaultPmId?'checked':''} /><span>${(pm.card?.brand||pm.brand||'Card').toString().replace(/^./,c=>c.toUpperCase())} •••• ${pm.card?.last4 || pm.last4 || '••••'}${pm.id===defaultPmId?' <span class="badge default">Default</span>':''}</span></div><small>${expTxt}</small>`;
        wrap.appendChild(label);
      });

      // ACH
      banks.forEach(pm=>{
        const id=`pick-${pm.id}`;
        const ach=normalizeAch(pm);
        const bankName=ach.bank_name;
        const acctType=ach.account_type?` (${ach.account_type})`:'';
        const verified=ach.verified;

        const label=document.createElement('label'); label.className='pm';
        label.innerHTML = `<div class="meta"><input type="radio" name="pmPick" id="${id}" value="${pm.id}" ${verified?'':'disabled'} ${pm.id===defaultPmId && verified?'checked':''} /><span>${bankName} •••• ${ach.last4}${acctType}${pm.id===defaultPmId && verified?' <span class="badge default">Default</span>':''} <span class="badge" style="background:#0ea5e9;color:#fff">ACH</span></span></div><small>${verified?'Verified bank account':'Not verified — cannot charge'}</small>`;
        wrap.appendChild(label);
      });
    }

    async function submitCharge(e){
      e.preventDefault();
      document.getElementById('resultMsg').textContent = '';

      const cid=getCurrentCustomerId();
      if (!cid){ alert('Please select a client.'); return; }

      const amountVal=parseFloat(document.getElementById('amount').value);
      if (!amountVal || amountVal<=0){ document.getElementById('resultMsg').textContent='❌ Please enter a valid amount.'; return; }

      // Compute total (adds 3.5% if 'Inbound Ad Spend')
const choice = $('#descSel').value; // which description user picked
const totalCents = computeTotalCents(amountVal, choice);
const totalDollars = totalCents / 100;


      // Build inbound description + statement descriptor
      let statementDescriptor = BASE_INBOUND_DESCRIPTOR;
      let desc = '';

      const choice = document.getElementById('descSel').value;
      const clientName = getSelectedClientName();
      const monthLabel = currentMonthYearLabel();

      if (choice === 'inbound_retainer') {
        statementDescriptor = 'ROOFENGINE INBOUND RETAINER';
        desc = `${monthLabel} Retainer - ${clientName}`;
      } else if (choice === 'inbound_adspend') {
        statementDescriptor = 'ROOFENGINE INBOUND ADSPEND';
        desc = `${monthLabel} Ad Spend - ${clientName}`;
      } else if (choice === '__other__') {
        statementDescriptor = 'ROOFENGINE INBOUND';
        desc = document.getElementById('descOther').value.trim();
      } else {
        document.getElementById('resultMsg').textContent = '❌ Please choose or enter a description.';
        return;
      }
      if (!desc){
        document.getElementById('resultMsg').textContent='❌ Please choose or enter a description.';
        return;
      }
// Compute total (adds 3.5% if 'Inbound Ad Spend')
const choice = $('#descSel').value; // you already have this
const totalCents = computeTotalCents(amountVal, choice);
const totalDollars = totalCents / 100;

      
      // Which PM?
      const checked = document.querySelector('input[name="pmPick"]:checked');
      let pmId = checked ? checked.value : null;

      showOverlay(true);
      try{
        if (!pmId){
          mountCardElement();
          const { paymentMethod, error } = await stripe.createPaymentMethod({ type:'card', card: cardEl });
          if (error) throw new Error(error.message);
          pmId = paymentMethod.id;
        }

        if (currentWhen === 'now'){
          const res = await fetchWithTimeout('/.netlify/functions/outbound-client-charge-now',{
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({
              customerId: cid,
              paymentMethodId: pmId,
              amount: totalCents, // includes +3.5% if Ad Spend
              statementDescriptor,
              description: desc
            })
          }, NET_TIMEOUT_MS).then(r=>r.json());
          if (res.error) throw new Error(res.error);
          document.getElementById('resultMsg').textContent = res.settlement_notice ? '✅ Charged. ' + res.settlement_notice : '✅ Charged successfully';
        } else {
          const date=document.getElementById('chargeDate').value;
          if (!date){ document.getElementById('resultMsg').textContent='❌ Please pick a future date.'; showOverlay(false); return; }
          const time='09:00';
          let timezone='UTC'; try { timezone=Intl.DateTimeFormat().resolvedOptions().timeZone||'UTC'; } catch {}

          const res = await fetchWithTimeout('/.netlify/functions/outbound-client-charge-later',{
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({
              customerId: cid,
              paymentMethodId: pmId,
              productId: PRODUCT_ID,
              amount: totalDollars, // includes +3.5% if Ad Spend
              date, time, timezone,
              description: desc,
              statementDescriptor
            })
          }, NET_TIMEOUT_MS).then(r=>r.json());
          if (res.error) throw new Error(res.error);
          document.getElementById('resultMsg').textContent = '✅ Scheduled for ' + date + ' 09:00 AM ET';
        }

        // Reset inputs
        document.getElementById('amount').value='';
        if (document.getElementById('descSel').value==='__other__') document.getElementById('descOther').value='';

        await refreshRightPanel();
      }catch(err){
        document.getElementById('resultMsg').textContent = '❌ ' + (err?.message || String(err));
      }finally{
        showOverlay(false);
      }
    }

    document.addEventListener('click', (e)=>{ if (e.target && e.target.id==='saveCard') saveNewCard(e); });
    async function saveNewCard(e){
      e.preventDefault();
      const cid=getCurrentCustomerId(); if(!cid){ alert('Select a client first.'); return; }
      document.getElementById('saveCardMsg').textContent=''; showOverlay(true);
      try{
        mountCardElement();
        const { clientSecret, error:siErr } = await fetchWithTimeout('/.netlify/functions/create-setup-intent',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ customerId: cid }) }, NET_TIMEOUT_MS).then(r=>r.json());
        if (siErr || !clientSecret) throw new Error(siErr || 'No client secret');

        const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret,{ payment_method:{ card: cardEl } });
        if (error) throw new Error(error.message);

        const attach = await fetchWithTimeout('/.netlify/functions/attach-method',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ customerId: cid, paymentMethodId: setupIntent.payment_method, setDefault: true }) }, NET_TIMEOUT_MS).then(r=>r.json());
        if (attach.error) throw new Error(attach.error);

        document.getElementById('saveCardMsg').textContent = '✅ Card saved & set as default';
        await refreshRightPanel();
        await refreshPaymentPickers();
        alert('New card saved & set as default. Please choose which card to use for this charge.');
      }catch(err){
        document.getElementById('saveCardMsg').textContent = '❌ ' + (err?.message || err);
      }finally{
        showOverlay(false);
      }
    }
  </script>
</body>
</html>
