<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inbound Client Billing</title>
</head>
<body>
  <h1>Inbound Client Billing</h1>
  <select id="custSel"></select>
  <div id="chargeSection" style="display:none"></div>
  <script type="module">
  import { isInbound, isInbound } from "./js/filters.js";
  window.PAGE_FILTER_NAME = 'inbound';
  window.IS_OUTBOUND = isInbound;
  window.IS_INBOUND = isInbound;
</script>
  <script>async function loadCustomersAndFill(){
  try{
    const isInboundPage = (window.PAGE_FILTER_NAME === 'outbound');
    let payload;
    try {
      const primary = isInboundPage
        ? '/.netlify/functions/list-outbound-customers'
        : '/.netlify/functions/list-customers?type=inbound';
      payload = await fetch(primary, { cache: 'no-store' }).then(r=>r.json());
      if (!Array.isArray(payload)) throw new Error('bad payload');
    } catch {
      const fallback = isInboundPage
        ? '/.netlify/functions/list-customers?type=outbound'
        : '/.netlify/functions/list-customers?type=inbound';
      payload = await fetch(fallback, { cache: 'no-store' }).then(r=>r.json());
    }
    customers = payload;
    const sel = document.querySelector('#custSel');
    sel.innerHTML = '<option value="" disabled selected>Select a clientâ€¦</option>';
    customers.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id;
      opt.textContent=c.name || c.email || c.id;
      sel.appendChild(opt);
    });
    const urlId = new URLSearchParams(location.search).get('customerId');
    if (urlId && customers.find(x=>x.id===urlId)) {
      sel.value = urlId;
      document.querySelector('#chargeSection').style.display='block';
      await onSelectCustomer(urlId);
    }
  } catch(err) {
    console.error('[loadCustomersAndFill]', err);
    document.querySelector('#custSel').innerHTML = '<option value="" disabled selected>Failed to load customers</option>';
    document.querySelector('#selHelp').textContent = 'Please refresh or contact support.';
  }
}</script>
</body>
</html>
