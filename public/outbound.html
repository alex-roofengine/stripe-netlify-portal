<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outbound Client Billing</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body,html{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif;background:#fafafa;color:#111}

    /* Top bar */
    .topbar{
      position:sticky;top:0;z-index:20;
      display:flex;align-items:center;gap:1rem;
      background:#000;color:#fff;padding:.85rem 1.25rem;flex-wrap:wrap
    }
    .brand{display:flex;align-items:center;gap:.75rem;min-width:280px}
    .brand img{height:28px}
    .brand .title strong{display:block;line-height:1}
    .badge-outbound{
      background:#F3E72F;color:#111;font-weight:800;border-radius:8px;
      padding:.2rem .5rem;margin-left:.4rem;display:inline-block
    }
    .spacer{flex:1}
    .clock{color:#ddd;font-weight:600;min-width:max-content}
    .home{
      color:#fff;text-decoration:none;border:2px solid #b50000;background:#cc0000;
      border-radius:10px;padding:.55rem .9rem;font-weight:800
    }

    /* Progress bar */
    #progress{height:3px;background:#F3E72F;width:0;transition:width .25s ease;position:relative;z-index:19}

    .wrap{max-width:1200px;margin:0 auto;padding:1.25rem}

    /* Grid: two columns */
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:1.25rem}

    .card{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:1rem 1.25rem}
    .card h2{margin:.25rem 0 1rem;font-size:1.15rem}
    .muted{color:#666}

    /* Rows & inputs */
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    select, input[type="date"], input[type="number"], input[type="text"]{
      padding:.65rem .75rem;border:1px solid #d6d6d6;border-radius:8px;background:#fff;font-size:1rem
    }
    select{min-width:300px}
    label{display:block;font-weight:600;margin:.25rem 0 .35rem}

    /* Pill choices */
    .choices{display:flex;gap:.75rem}
    .pill{
      border:1px solid #d6d6d6;border-radius:999px;padding:.45rem .9rem;cursor:pointer;
      font-weight:700;user-select:none
    }
    .pill[data-active="true"]{background:#111;color:#fff;border-color:#111}
    .pill.green[data-active="true"]{background:#00D084;border-color:#00D084}
    .pill.orange[data-active="true"]{background:#ff7800;border-color:#ff7800}

    /* Stripe card box */
    #new-card{border:1px solid #d6d6d6;border-radius:8px;padding:12px;margin-top:.25rem}

    /* PM rows */
    .pm{display:flex;justify-content:space-between;align-items:center;
        border:1px solid #eee;border-radius:10px;padding:.65rem .75rem;margin:.5rem 0}
    .pm .meta{display:flex;align-items:center;gap:.5rem}
    .badge{display:inline-block;border-radius:6px;padding:2px 6px;font-size:.8rem;font-weight:800}
    .badge.default{background:#007bff;color:#fff}
    .badge.recent{background:#16a34a;color:#fff}
    .pm small{color:#666}

    .link-btn{border:1px solid #ddd;background:#fff;border-radius:8px;padding:.45rem .75rem;cursor:pointer;font-weight:700}

    /* Description tip */
    .tip{
      background:#fff9d6;border:2px dashed #e8d269;border-radius:10px;
      padding:.6rem .75rem;color:#5c4a00;margin-top:.45rem;font-size:.95rem
    }

    /* Submit */
    #submit{border-radius:10px;padding:.7rem 1.2rem;border-color:#111}
    #resultMsg{margin-left:.5rem}

    /* History table (right) */
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    th{font-weight:700}
    .nowrap{white-space:nowrap}
    .status{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .status.ok{background:#e8f7ee;color:#1a7f37}
    .status.fail{background:#fde8ea;color:#b42318}

    /* Loading overlay for heavy ops */
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .loader{width:58px;height:58px;border-radius:50%;border:6px solid #fff;border-top-color:transparent;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Responsive */
    @media(max-width: 980px){
      .grid{grid-template-columns:1fr}
      select{min-width:unset;width:100%}
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <img src="assets/logo.svg" alt="RoofEngine" />
      <div class="title">
        <strong>RoofEngine Billing Portal</strong>
        <span class="badge-outbound">(Outbound)</span>
      </div>
    </div>
    <div class="spacer"></div>
    <div id="clock" class="clock">—</div>
    <a class="home" href="index.html">← Home</a>
  </header>
  <div id="progress"></div>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h2>Charge an Outbound Client</h2>

        <!-- Customer selector -->
        <div class="row" style="margin-bottom:.5rem">
          <label for="custSel" style="margin:0">Select client</label>
          <select id="custSel">
            <option value="" disabled selected>Loading customers…</option>
          </select>
          <span class="muted" id="selHelp">If you don't see a client in this list, please contact tech support.</span>
        </div>

        <!-- The rest of the form stays hidden until a client is chosen -->
        <div id="chargeSection" style="display:none">
          <div class="card" style="margin-top:1rem">
            <!-- Payment Method -->
            <div>
              <label>Payment Method</label>
              <div id="pmPicker"></div>
              <div id="noPmHint" class="muted" style="display:none;margin-top:.25rem">
                No card on file. Add a new card below.
              </div>
              <!-- Add-new-card button (only when PMs exist) -->
              <div id="addNewBtnWrap" class="row" style="display:none;margin-top:.5rem">
                <button id="showAddCard" class="link-btn">➕ Add a New Card</button>
              </div>
              <!-- Add-new-card form (hidden by default unless no PMs or user clicks) -->
              <div id="newCardWrap" style="display:none;margin-top:.5rem">
                <div id="new-card"></div>
                <div class="row" style="margin-top:.6rem">
                  <button id="saveCard" class="link-btn">Save card & set default</button>
                  <span id="saveCardMsg" class="muted"></span>
                </div>
              </div>
            </div>

            <!-- Amount -->
            <div style="margin-top:1rem">
              <label for="amount">Amount (USD)</label>
              <input type="number" id="amount" min="1" step="1" placeholder="2500" required>
            </div>

            <!-- Description -->
            <div style="margin-top:.6rem">
              <label for="descSel">Description</label>
              <select id="descSel" required>
                <option value="" disabled selected>Select a description…</option>
                <option value="RoofEngine Outbound Monthly Retainer - [MMM, YYYY]">RoofEngine Outbound Monthly Retainer - [MMM, YYYY]</option>
                <option value="RoofEngine Outbound Deposit">RoofEngine Outbound Deposit</option>
                <option value="RoofEngine Outbound Trial">RoofEngine Outbound Trial</option>
                <option value="RoofEngine Outbound Pay Per Lead">RoofEngine Outbound Pay Per Lead</option>
                <option value="__other__">Other, please type in the description…</option>
              </select>
              <input id="descOther" type="text" placeholder="Enter custom description…" style="display:none;margin-top:.5rem">
              <div class="tip">
                Monthly Retainer → the monthly payment • Deposit → partial upfront •
                Pay Per Lead → PPL • “Other” → special cases / top-ups.
              </div>
            </div>

            <!-- Charge when -->
            <div style="margin-top:1rem">
              <label>Charge timing</label>
              <div class="choices">
                <div class="pill green" data-role="when" data-val="now" data-active="true">Charge Now</div>
                <div class="pill orange" data-role="when" data-val="later">Charge Later</div>
              </div>
              <div id="laterBox" style="margin-top:.6rem;display:none">
                <label for="chargeDate" style="display:inline">Charge date</label>
                <input type="date" id="chargeDate">
                <span class="muted" style="margin-left:.35rem">Charged 9:00 AM America/New_York</span>
              </div>
            </div>

            <!-- Submit -->
            <div style="margin-top:1.25rem">
              <button id="submit" class="pill" style="border:2px solid #111">Submit Charge</button>
              <span id="resultMsg" class="muted"></span>
            </div>
          </div>

          <div class="muted" style="margin-top:1rem">
            Note: This tool charges <strong>credit cards only</strong>. For ACH, please contact the billing team.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2 id="panelTitle">Client</h2>
        <div style="margin-bottom:1rem">
          <div id="coName" style="font-weight:700">—</div>
          <div id="contactName" class="muted">—</div>
          <div id="coEmail" class="muted">—</div>
        </div>

        <div style="margin:.75rem 0">
          <strong>Payment Methods</strong>
          <div id="pmList"></div>
        </div>

        <div style="margin-top:1rem">
          <strong>Recent Payments</strong>
          <table style="margin-top:.4rem">
            <thead>
              <tr>
                <th>Date</th><th>Description</th><th>Status</th><th>Receipt</th>
              </tr>
            </thead>
            <tbody id="histBody">
              <tr><td colspan="4" class="muted">Select a client to load history.</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>

  <!-- Loading overlay for heavy ops -->
  <div id="loadingOverlay"><div class="loader" aria-label="Processing…"></div></div>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // ---------- Helpers ----------
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const money = c => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format((+c||0)/100);
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const fmtDate = unix => { const d = new Date(unix*1000); return `${monthNames[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; };
    const cap = s => s ? s.charAt(0).toUpperCase()+s.slice(1) : '';
    const setProgress = val => { $('#progress').style.width = val + '%'; };
    const showOverlay = on => { $('#loadingOverlay').style.display = on ? 'flex' : 'none'; };

    function tickClock(){
      const opts={ timeZone:'America/New_York', month:'long', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true };
      $('#clock').textContent = `Today is ${new Intl.DateTimeFormat('en-US',opts).format(new Date())} EST`;
    }
    tickClock(); setInterval(tickClock, 60000);

    // ---------- State ----------
    let stripe, elements, cardEl;
    let customers = [];
    let selectedCustomer = null;
    let defaultPmId = null;
    let lastAddedPmId = null;
    let currentWhen = 'now';
    const OUTBOUND_DESCRIPTOR = 'ROOFENGINE OUTBOUND';
    const OUTBOUND_PRODUCT_ID = 'prod_TC1NUvIsUykBKs';

    // ---------- Boot ----------
    (async function init(){
      try{
        setProgress(10);
        const { publishableKey } = await fetch('/.netlify/functions/public-keys',{cache:'no-store'}).then(r=>r.json());
        stripe = Stripe(publishableKey);
        elements = stripe.elements();

        setProgress(25);
        // Description default month label
        const monthTemplate = `RoofEngine Outbound Monthly Retainer - [${monthNames[new Date().getMonth()]}, ${new Date().getFullYear()}]`;
        [...$('#descSel').options].forEach(o=>{ if(o.value.startsWith('RoofEngine Outbound Monthly Retainer')) o.textContent = monthTemplate; });

        bindUI();
        await loadCustomersAndFill();
        setProgress(100);
        setTimeout(()=>setProgress(0), 700);
      }catch(e){
        console.error(e);
        alert('Failed to load keys or customers. Please refresh.');
      }
    })();

    function bindUI(){
      $('#descSel').addEventListener('change', ()=>{
        $('#descOther').style.display = ($('#descSel').value === '__other__') ? 'block' : 'none';
      });

      $$('[data-role="when"]').forEach(p=>{
        p.addEventListener('click', ()=>{
          $$('[data-role="when"]').forEach(x=>x.setAttribute('data-active','false'));
          p.setAttribute('data-active','true');
          currentWhen = p.dataset.val;
          $('#laterBox').style.display = currentWhen==='later' ? 'block' : 'none';
        });
      });

      $('#submit').addEventListener('click', submitCharge);

      $('#custSel').addEventListener('change', async ()=>{
        if (!$('#chargeSection').style.display || $('#chargeSection').style.display==='none'){
          $('#chargeSection').style.display = 'block';
        }
        await onSelectCustomer($('#custSel').value);
      });

      // show Add New Card section on demand
      $('#showAddCard').addEventListener('click', ()=>{
        $('#newCardWrap').style.display = 'block';
      });
    }

    async function onSelectCustomer(id){
      setProgress(15);
      $('#resultMsg').textContent = '';
      selectedCustomer = customers.find(c=>c.id===id) || null;

      // Show slim loading bar while fetching everything
      setProgress(50);
      await refreshRightPanel();
      setProgress(75);
      await refreshPaymentPickers();
      setProgress(100);
      setTimeout(()=>setProgress(0), 500);
    }

    async function loadCustomersAndFill(){
      const all = await fetch('/.netlify/functions/list-customers').then(r=>r.json());
      const outs = all.filter(c=>c.metadata && c.metadata.client_type === 'outbound');

      // newest first by created, then remaining A→Z
      const newest = outs.slice().sort((a,b)=>(b.created||0)-(a.created||0));
      const top = newest[0] ? [newest[0]] : [];
      const rest = outs.filter(c=>!top.find(t=>t.id===c.id))
                       .sort((a,b)=> ( (a.name||a.email||'').toLowerCase() )
                         .localeCompare( (b.name||b.email||'').toLowerCase() ));

      customers = [...top, ...rest];

      const sel = $('#custSel');
      sel.innerHTML = '<option value="" disabled selected>Select a client…</option>';
      customers.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name || c.email || c.id;
        sel.appendChild(opt);
      });

      // If URL has customerId, preselect
      const urlId = new URLSearchParams(location.search).get('customerId');
      if (urlId) { sel.value = urlId; $('#chargeSection').style.display='block'; await onSelectCustomer(urlId); }
    }

    async function refreshRightPanel(){
      if (!selectedCustomer){
        $('#panelTitle').textContent = 'Client';
        $('#coName').textContent = '—';
        $('#contactName').textContent = '—';
        $('#coEmail').textContent = '—';
        $('#pmList').innerHTML = '';
        $('#histBody').innerHTML = '<tr><td colspan="4" class="muted">Select a client to load history.</td></tr>';
        return;
      }

      $('#panelTitle').textContent = `Client — ${selectedCustomer.name || selectedCustomer.id}`;
      $('#coName').textContent     = selectedCustomer.name || '—';
      $('#contactName').textContent= selectedCustomer.metadata?.contact_name || '—';
      $('#coEmail').textContent    = selectedCustomer.email || '—';

      // PMs (right)
      const pmData = await fetch(`/.netlify/functions/list-payment-methods?customerId=${selectedCustomer.id}`).then(r=>r.json());
      defaultPmId = pmData.defaultPaymentMethod || null;
      const listEl = $('#pmList'); listEl.innerHTML = '';
      if (!pmData.paymentMethods?.length){
        listEl.innerHTML = '<div class="muted">No payment methods on file.</div>';
      } else {
        pmData.paymentMethods.forEach(pm=>{
          const exp = `Expires ${monthNames[(pm.card.exp_month||1)-1]} ${pm.card.exp_year}`;
          const row = document.createElement('div');
          row.className = 'pm';
          const l = document.createElement('div');
          l.className = 'meta';
          l.innerHTML = `${cap(pm.card.brand)} •••• ${pm.card.last4}` +
                        (pm.id===defaultPmId ? ' <span class="badge default">Default</span>' : '');
          const r = document.createElement('div'); r.innerHTML = `<small>${exp}</small>`;
          row.append(l,r);
          listEl.append(row);
        });
      }

      // History (5 most recent charges)
      const charges = await fetch(`/.netlify/functions/list-charges?customerId=${selectedCustomer.id}`).then(r=>r.json());
      const body = $('#histBody'); body.innerHTML='';
      if (!charges?.length){
        body.innerHTML = '<tr><td colspan="4" class="muted">No payments found.</td></tr>';
      } else {
        charges.slice(0,5).forEach(ch=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap">${fmtDate(ch.created)}</td>
            <td>${ch.description || '—'}</td>
            <td>${ch.status==='succeeded' ? '<span class="status ok">Paid</span>' : '<span class="status fail">Failed</span>'}</td>
            <td>${ch.receipt_url ? `<a target="_blank" href="${ch.receipt_url}">Receipt</a>` : '—'}</td>
          `;
          body.appendChild(tr);
        });
      }
    }

    function mountCardElement(){
      if (cardEl) return; // already mounted
      cardEl = elements.create('card',{ style:{ base:{ fontFamily:'Inter, sans-serif' } } });
      cardEl.mount('#new-card');
    }

    async function refreshPaymentPickers(){
    const wrap = $('#pmPicker'); wrap.innerHTML = '';
    $('#addNewBtnWrap').style.display = 'none';
    $('#newCardWrap').style.display   = 'none';
    lastAddedPmId = null;

    const data = await fetch(`/.netlify/functions/list-payment-methods?customerId=${selectedCustomer.id}`).then(r=>r.json());
    defaultPmId = data.defaultPaymentMethod || null;

    // Separate by type for pretty labels (we'll show them in one list)
    const cards = (data.paymentMethods || []).filter(p => p.type === 'card');
    const banks = (data.paymentMethods || []).filter(p => p.type === 'us_bank_account'); // already verified per function

    // NOTHING ON FILE
    if ((!cards.length) && (!banks.length)){
      $('#noPmHint').style.display = 'block';
      // show inline card form automatically
      $('#newCardWrap').style.display = 'block';
      mountCardElement();
      return;
    }
    $('#noPmHint').style.display = 'none';
    $('#addNewBtnWrap').style.display = 'flex';

    // Helper for PM row
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    // CARD ROWS
    cards.forEach(pm=>{
      const id = `pick-${pm.id}`;
      const label = document.createElement('label');
      label.className = 'pm';
      const recentBadge = (pm.id===lastAddedPmId) ? ' <span class="badge recent">Added Recently</span>' : '';
      const expTxt = pm.card?.exp_month && pm.card?.exp_year
        ? `Expires ${monthNames[(pm.card.exp_month||1)-1]} ${pm.card.exp_year}`
        : '';
      label.innerHTML = `
        <div class="meta">
          <input type="radio" name="pmPick" id="${id}" value="${pm.id}" ${pm.id===defaultPmId?'checked':''} />
          <span>${cap(pm.card.brand)} •••• ${pm.card.last4}
            ${pm.id===defaultPmId? ' <span class="badge default">Default</span>': ''}
            ${recentBadge}
          </span>
        </div>
        <small>${expTxt}</small>
      `;
      wrap.appendChild(label);
    });

    // BANK ROWS (ACH) — verified only
    banks.forEach(pm=>{
      const id = `pick-${pm.id}`;
      const info = pm.bank || {};
      const bankName = info.bank_name || 'Bank Account';
      const acctType = info.account_type ? ` (${info.account_type})` : '';
      const verified = info.status === 'verified';
      const label = document.createElement('label');
      label.className = 'pm';
      label.innerHTML = `
        <div class="meta">
          <input type="radio" name="pmPick" id="${id}" value="${pm.id}" ${pm.id===defaultPmId?'checked':''} />
          <span>${bankName} •••• ${info.last4}${acctType}
            ${pm.id===defaultPmId? ' <span class="badge default">Default</span>': ''}
            ${verified ? ' <span class="badge" style="background:#0ea5e9;color:#fff">ACH</span>' : ''}
          </span>
        </div>
        <small>${verified ? 'Verified bank account' : 'Not verified'}</small>
      `;
      wrap.appendChild(label);
    });

    // ACH settlement reminder under the picker when a bank option is chosen
    // (Create or reuse a small hint node)
    let achHint = document.getElementById('achHint');
    if (!achHint) {
      achHint = document.createElement('div');
      achHint.id = 'achHint';
      achHint.className = 'muted';
      achHint.style.marginTop = '.35rem';
      wrap.parentElement.appendChild(achHint);
    }

    const setAchHint = () => {
      const chosen = document.querySelector('input[name="pmPick"]:checked');
      if (!chosen) { achHint.textContent = ''; return; }
      const pmChosen = [...cards, ...banks].find(x=>x.id === chosen.value);
      if (pmChosen?.type === 'us_bank_account') {
        achHint.textContent = 'Note: ACH debits can take up to 7 business days to settle.';
      } else {
        achHint.textContent = '';
      }
    };
    // Run once & then on change
    setAchHint();
    wrap.addEventListener('change', setAchHint, { once:false });
  }
    async function saveNewCard(e){
      e.preventDefault();
      if (!selectedCustomer) { alert('Select a client first.'); return; }
      $('#saveCardMsg').textContent = '';
      showOverlay(true);
      try{
        mountCardElement();

        // 1) SetupIntent
        const { clientSecret, error:siErr } = await fetch('/.netlify/functions/create-setup-intent',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ customerId: selectedCustomer.id })
        }).then(r=>r.json());
        if (siErr || !clientSecret) throw new Error(siErr || 'No client secret');

        // 2) Confirm
        const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret,{ payment_method:{ card: cardEl } });
        if (error) throw new Error(error.message);

        // 3) Attach & set default
        const attach = await fetch('/.netlify/functions/attach-method',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ customerId: selectedCustomer.id, paymentMethodId: setupIntent.payment_method, setDefault: true })
        }).then(r=>r.json());
        if (attach.error) throw new Error(attach.error);

        lastAddedPmId = setupIntent.payment_method;
        $('#saveCardMsg').textContent = '✅ Card saved & set as default';
        await refreshRightPanel();
        await refreshPaymentPickers();
        alert('New card saved & set as default. Please choose which card to use for this charge.');
        // focus the picker
        const radio = document.querySelector(`input[name="pmPick"][value="${lastAddedPmId}"]`);
        if (radio) radio.scrollIntoView({behavior:'smooth', block:'center'});
      }catch(err){
        $('#saveCardMsg').textContent = '❌ ' + (err?.message || err);
      }finally{ showOverlay(false); }
    }

    function getSelectedPmId(){
      const checked = document.querySelector('input[name="pmPick"]:checked');
      return checked ? checked.value : null;
    }

    function resolveDescription(){
      if ($('#descSel').value === '__other__'){
        return $('#descOther').value.trim();
      }
      // Fill [MMM, YYYY]
      return $('#descSel').value.replace('[MMM, YYYY]', `${monthNames[new Date().getMonth()]}, ${new Date().getFullYear()}`);
    }

    async function submitCharge(e){
  e.preventDefault();
  $('#resultMsg').textContent = '';

  if (!selectedCustomer){
    alert('Please select a client.');
    return;
  }

  const amountVal = parseFloat($('#amount').value);
  if (!amountVal || amountVal <= 0){
    alert('Enter a valid amount.');
    return;
  }

  const desc = resolveDescription();
  if (!desc){
    alert('Please choose or enter a description.');
    return;
  }

  // Pick a PM, or fall back to creating a one-off card PM from the card element
  let pmId = getSelectedPmId();

  showOverlay(true);
  try{
    if (!pmId){
      // If no PM selected/available, create one from the card fields shown on the page
      mountCardElement();
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type:'card',
        card: cardEl
      });
      if (error) throw new Error(error.message);
      pmId = paymentMethod.id;
    }

    if (currentWhen === 'now'){
      // Charge NOW (supports card or ACH automatically on the server)
      const res = await fetch('/.netlify/functions/outbound-client-charge-now',{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          customerId: selectedCustomer.id,
          paymentMethodId: pmId,
          amount: Math.round(amountVal * 100),
          statementDescriptor: OUTBOUND_DESCRIPTOR,
          description: desc
        })
      }).then(r=>r.json());

      if (res.error) throw new Error(res.error);

      // If server indicates an ACH settlement note, show it
      if (res.settlement_notice) {
        $('#resultMsg').textContent = '✅ Charged. ' + res.settlement_notice;
      } else {
        $('#resultMsg').textContent = '✅ Charged successfully';
      }

    } else {
      // Charge LATER (schedule)
      const date = $('#chargeDate').value;
      if (!date){
        showOverlay(false);
        alert('Pick a charge date.');
        return;
      }

      const res = await fetch('/.netlify/functions/outbound-client-charge-later',{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          customerId: selectedCustomer.id,
          paymentMethodId: pmId,
          productId: OUTBOUND_PRODUCT_ID,
          date,
          description: desc,
          statementDescriptor: OUTBOUND_DESCRIPTOR
        })
      }).then(r=>r.json());

      if (res.error) throw new Error(res.error);
      $('#resultMsg').textContent = '✅ Scheduled for ' + date + ' 09:00 AM ET';
    }

    // Clear inputs that make sense after a successful action
    $('#amount').value = '';
    if ($('#descSel').value === '__other__') $('#descOther').value = '';

    // Refresh the right-hand panel (PMs & recent payments)
    await refreshRightPanel();

  } catch(err){
    $('#resultMsg').textContent = '❌ ' + (err?.message || String(err));
  } finally {
    showOverlay(false);
  }
}


    // attach handler after elements exist
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'saveCard') saveNewCard(e);
    });
  </script>
</body>
</html>
