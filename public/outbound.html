<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outbound Client Billing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body,html { margin:0; padding:0; height:100%; font-family:'Inter',sans-serif; }
    .sidebar { background:#000; color:#fff; width:280px; position:fixed; height:100%; padding:2em; box-sizing:border-box; }
    .content { margin-left:280px; padding:2em; }
    h1 { font-weight:600; margin-bottom:1em; }
    .btn { display:inline-block; border:none; border-radius:6px; font-weight:600; cursor:pointer; padding:1em 2em; margin-right:10px; }
    .btn-green { background:#28a745; color:#fff; }
    .btn-gray { background:#e0e0e0; color:#000; }
    label { font-weight:600; display:block; margin-top:20px; }
    input { padding:10px; width:100%; margin-top:8px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
    #card-element { margin-top:12px; padding:12px; border:1px solid #ccc; border-radius:4px; }
    #submit { margin-top:20px; background:#007bff; color:#fff; width:100%; padding:1em; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
    #later-options { display:none; margin-top:20px; }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .loader {
      width: 64px; height: 64px; border-radius: 50%;
      border: 6px solid #fff; border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media(max-width:768px){
      .sidebar{position:relative;width:100%;height:auto;padding:1em}
      .content{margin-left:0;padding:1em}
      .btn{width:100%;margin-bottom:.75em}
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" width="150" alt="RoofEngine" />
    <h2>RoofEngine Billing Portal</h2>
    <p id="timestamp"></p>
    <a href="index.html" class="home">← Home</a><br><br>
    <a href="outbound.html" class="home">↳ Outbound Billing</a>
  </div>

  <div class="content">
    <h1>Outbound Client Billing</h1>
    <p id="client-info">Loading client...</p>

    <!-- Retainer Amount -->
    <label for="amount">Retainer Amount (USD)</label>
    <input type="number" id="amount" placeholder="Enter amount to charge" required />

    <!-- Buttons -->
    <div style="margin-top:20px;">
      <button class="btn btn-green" id="charge-now">Charge Now</button>
      <button class="btn btn-gray" id="charge-later">Charge Later</button>
    </div>

    <!-- Charge Later Options -->
    <div id="later-options">
      <label for="due-date">Select Due Date</label>
      <input type="date" id="due-date" />
    </div>

    <!-- Stripe Card Element -->
    <label for="card-element">Card Details</label>
    <div id="card-element"></div>
    <button id="submit">Submit</button>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay"><div class="loader" aria-label="Processing…"></div></div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // Tiny uuid generator for idempotency
    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    function showLoading(on) {
      document.getElementById("loadingOverlay").style.display = on ? "flex" : "none";
      const btn = document.getElementById("submit");
      btn.disabled = on;
      btn.style.opacity = on ? 0.7 : 1;
    }

    (async function () {
      // 1) Fetch publishable key from Netlify Function (you must have netlify/functions/public-keys.js)
      const res = await fetch("/.netlify/functions/public-keys", { cache: "no-store" });
      const { publishableKey } = await res.json();
      if (!publishableKey) { alert("⚠️ Missing Stripe publishable key."); return; }

      // 2) Init Stripe
      const stripe = Stripe(publishableKey);
      const elements = stripe.elements();
      const cardElement = elements.create("card");
      cardElement.mount("#card-element");

      let clientId = null;
      let mode = "now";

      async function loadClient() {
        const res = await fetch("/.netlify/functions/get-latest-outbound-customer");
        if (!res.ok) {
          document.getElementById("client-info").innerText = "⚠️ Failed to load client.";
          return;
        }
        const data = await res.json();
        clientId = data.id;
        document.getElementById("client-info").innerText =
          `Charging client: ${data.name || data.email || data.id}`;
      }
      loadClient();

      document.getElementById("charge-now").addEventListener("click", () => {
        mode = "now";
        document.getElementById("later-options").style.display = "none";
      });
      document.getElementById("charge-later").addEventListener("click", () => {
        mode = "later";
        document.getElementById("later-options").style.display = "block";
      });

      document.getElementById("submit").addEventListener("click", async (e) => {
        e.preventDefault();

        const amount = document.getElementById("amount").value;
        if (!amount || amount <= 0) {
          alert("Please enter a valid retainer amount.");
          return;
        }

        showLoading(true);
        try {
          // Create payment method in browser
          const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: "card",
            card: cardElement,
          });
          if (error) { alert(error.message); return; }

          const payload = {
            customerId: clientId,
            paymentMethodId: paymentMethod.id,
            amount: amount,
            requestId: uuid() // used by server for idempotency
          };

          let endpoint = "/.netlify/functions/outbound-client-charge-now";
          if (mode === "later") {
            const dueDate = document.getElementById("due-date").value;
            if (!dueDate) { alert("Please select a due date for scheduled charge."); return; }
            payload.dueDate = dueDate;
            endpoint = "/.netlify/functions/outbound-client-charge-later";
          }

          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (result.error) alert("Error: " + result.error);
          else alert("✅ Success: " + JSON.stringify(result));
        } catch (err) {
          alert("Unexpected error: " + (err?.message || err));
        } finally {
          showLoading(false);
        }
      });
    })();
  </script>
</body>
</html>
