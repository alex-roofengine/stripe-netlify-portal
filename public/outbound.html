<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoofEngine Outbound Billing</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://js.stripe.com/v3"></script>
</head>
<body>
  <main class="wrap">
    <h1>Charge an Outbound Client</h1>

    <section class="card">
      <label>Select Client</label>
      <select id="custSel">
        <option disabled selected>Loading customers…</option>
      </select>
      <p class="muted" id="selHelp">
        If you don’t see a client in this list, please contact tech support.
      </p>

      <div id="chargeForm" style="display:none;">
        <label>Payment Method</label>
        <div id="pmPicker"></div>

        <label>Amount (USD)</label>
        <input type="number" id="amount" min="1" step="1" placeholder="2500" required>

        <label>Description</label>
        <select id="descSel">
          <option disabled selected>Select description…</option>
          <option>RoofEngine Outbound Monthly Retainer</option>
          <option>Deposit</option>
          <option>Pay Per Lead</option>
          <option>Other</option>
        </select>

        <div class="choices">
          <button id="chargeNow">Charge Now</button>
          <button id="chargeLater">Charge Later</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);

    // Load customers fast
    async function loadCustomers() {
      try {
        let customers;
        try {
          customers = await fetch('/.netlify/functions/list-outbound-customers', { cache: 'no-store' }).then(r => r.json());
          if (!Array.isArray(customers)) throw new Error('Invalid payload');
        } catch {
          customers = await fetch('/.netlify/functions/list-customers?type=outbound', { cache: 'no-store' }).then(r => r.json());
        }

        const sel = $('#custSel');
        sel.innerHTML = '<option disabled selected>Select client…</option>';
        customers.forEach(c => {
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = c.name || c.email || c.id;
          sel.appendChild(o);
        });
      } catch (e) {
        console.error(e);
        $('#custSel').innerHTML = '<option disabled selected>Failed to load customers</option>';
      }
    }

    // Load payment methods
    async function loadPaymentMethods(id) {
      const wrap = $('#pmPicker');
      wrap.innerHTML = 'Loading…';
      const res = await fetch(`/.netlify/functions/list-payment-methods?customerId=${id}`).then(r => r.json());
      const pms = res.paymentMethods || [];
      if (!pms.length) {
        wrap.innerHTML = '<div>No payment methods found.</div>';
        return;
      }
      wrap.innerHTML = '';
      pms.forEach(pm => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `
          <input type="radio" name="pmPick" value="${pm.id}" />
          ${pm.card ? pm.card.brand + ' •••• ' + pm.card.last4 : pm.us_bank_account?.bank_name + ' •••• ' + pm.us_bank_account?.last4}
        `;
        wrap.append(lbl);
      });
    }

    $('#custSel').addEventListener('change', async e => {
      const id = e.target.value;
      if (!id) return;
      await loadPaymentMethods(id);
      $('#chargeForm').style.display = 'block';
    });

    async function postData(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return res.json();
    }

    async function submitCharge(later = false) {
      const customerId = $('#custSel').value;
      const paymentMethodId = document.querySelector('input[name="pmPick"]:checked')?.value;
      const amount = parseFloat($('#amount').value);
      const description = $('#descSel').value;
      if (!customerId || !paymentMethodId || !amount || !description) {
        alert('Please complete all fields');
        return;
      }

      const payload = {
        customerId,
        paymentMethodId,
        productId: 'prod_TC1NUvIsUykBKs',
        amount,
        description,
        statementDescriptor: 'ROOFENGINE OUTBOUND',
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString(),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };

      const endpoint = later
        ? '/.netlify/functions/outbound-client-charge-later'
        : '/.netlify/functions/outbound-client-charge-now';

      const result = await postData(endpoint, payload);
      if (result.error) alert('❌ ' + result.error);
      else alert(later ? '✅ Charge scheduled' : '✅ Charge successful');
    }

    $('#chargeNow').addEventListener('click', () => submitCharge(false));
    $('#chargeLater').addEventListener('click', () => submitCharge(true));

    loadCustomers();
  </script>
</body>
</html>
