<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outbound Client Billing</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    * { box-sizing: border-box; }
    body, html { margin:0; padding:0; height:100%; font-family:'Inter',sans-serif; }
    .sidebar {
      position:fixed; top:0; left:0; width:280px; height:100%;
      background:#000; color:#fff; padding:2em; display:flex; flex-direction:column;
    }
    .sidebar img { width:150px; margin-bottom:1em; }
    .sidebar h2 { font-size:1.25em; margin-bottom:1em; }
    .sidebar a { margin-top:auto; color:#fff; text-decoration:none; }

    .content { margin-left:280px; padding:2em; }
    h1 { margin-bottom:1em; }

    label { font-weight:600; display:block; margin-bottom:.5em; }
    input, .StripeElement { width:100%; padding:.75em; font-size:1em; margin-bottom:1em; }

    /* Card element styling */
    #card-element {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 1em;
    }

    /* Radio buttons */
    .radio-group {
      display:flex; gap:1em; margin-bottom:1em;
    }
    .radio-group .option { flex:1; text-align:center; }
    .radio-group input { display:none; }
    .radio-group span {
      display:block; padding:1em; border:2px solid #ccc; border-radius:6px;
      cursor:pointer; font-weight:600;
    }
    .radio-group input:checked + span {
      background:#00D084; color:#fff; border-color:#00D084;
    }

    button {
      padding:.75em 1.5em; font-weight:600;
      border:none; border-radius:6px; cursor:pointer;
      width:100%;
    }
    #submit-btn { background:#007bff; color:#fff; }

    #loading { margin:1em 0; display:none; }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" alt="RoofEngine" />
    <h2>RoofEngine<br/>Billing Portal</h2>
    <a href="index.html">← Home</a>
  </div>

  <div class="content">
    <h1>Outbound Client Billing</h1>
    <p id="client-info">Loading client...</p>

    <form id="outbound-form">
      <div class="radio-group">
        <label class="option">
          <input type="radio" name="chargeOption" value="now" required/>
          <span>Charge Now</span>
        </label>
        <label class="option">
          <input type="radio" name="chargeOption" value="later"/>
          <span>Charge Later</span>
        </label>
      </div>

      <input id="charge-date" type="date" style="display:none;" />

      <label>Card Details</label>
      <div id="card-element" class="StripeElement"></div>

      <button id="submit-btn" type="submit">Submit</button>
    </form>

    <div id="loading">Loading...</div>
  </div>

  <script>
    let stripe, elements, cardEl, customerId, companyName;

    async function init() {
      // fetch publishable key
      const keyRes = await fetch('/.netlify/functions/get-publishable-key');
      const { publishableKey } = await keyRes.json();
      stripe = Stripe(publishableKey);
      elements = stripe.elements();
      cardEl = elements.create('card');
      cardEl.mount('#card-element');

      // fetch latest outbound client
      fetch('/.netlify/functions/get-latest-outbound-customer')
      const { customer } = await clientRes.json();
      if (!customer) {
        document.getElementById('client-info').textContent = '❌ No outbound client found';
        document.getElementById('outbound-form').style.display = 'none';
        return;
      }
      customerId = customer.id;
      companyName = customer.name;
      document.getElementById('client-info').textContent = `Client: ${companyName} (${customer.email})`;
    }

    init();

    // toggle date picker
    document.querySelectorAll('input[name="chargeOption"]').forEach(radio => {
      radio.addEventListener('change', e => {
        document.getElementById('charge-date').style.display =
          e.target.value === 'later' ? 'block' : 'none';
      });
    });

    // handle form submit
    document.getElementById('outbound-form').onsubmit = async (e) => {
      e.preventDefault();
      document.getElementById('loading').style.display = 'block';

      try {
        // create setup intent
        const siRes = await fetch('/.netlify/functions/create-setup-intent', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ customerId })
        });
        const { clientSecret, error } = await siRes.json();
        if (error) throw new Error(error);

        // confirm card setup
        const { setupIntent, error:siErr } = await stripe.confirmCardSetup(
          clientSecret, { payment_method:{ card:cardEl } }
        );
        if(siErr) throw siErr;
        const pmId = setupIntent.payment_method;

        // branch based on charge option
        const opt = document.querySelector('input[name="chargeOption"]:checked').value;
        if(opt === 'now'){
          const chRes = await fetch('/.netlify/functions/outbound-client-charge-now',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ customerId, paymentMethodId:pmId, productId:'prod_OUTBOUND' })
          });
          const { error:chErr, invoice } = await chRes.json();
          if(chErr) throw new Error(chErr);
          alert('✅ Charged! Invoice: ' + invoice.id);
        } else {
          const date = document.getElementById('charge-date').value;
          if(!date) throw new Error('Please pick a date.');
          const scRes = await fetch('/.netlify/functions/outbound-client-charge-later',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ customerId, paymentMethodId:pmId, productId:'prod_OUTBOUND', date })
          });
          const { error:scErr, subscription } = await scRes.json();
          if(scErr) throw new Error(scErr);
          alert('✅ Recurring subscription scheduled for ' + date);
        }

        // clear form
        document.getElementById('outbound-form').reset();
        cardEl.clear();

      } catch(err) {
        alert('❌ '+err.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    };
  </script>
</body>
</html>
